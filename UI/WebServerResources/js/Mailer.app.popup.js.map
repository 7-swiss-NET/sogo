{"version":3,"file":"Mailer.app.popup.js","sources":["Mailer/Mailer.popup.js"],"names":["configure","$stateProvider","$urlRouterProvider","state","url","abstract","views","message","template","resolve","stateAccounts","stateAccount","stateMailbox","message@","controller","stateMessage","stateNewMessage","templateUrl","controllerAs","stateContent","otherwise","$q","Account","promise","$findAll","then","accounts","promises","angular","forEach","account","i","mailboxes","$getMailboxes","push","objects","all","$stateParams","_","find","id","accountId","decodeUriFilter","_find","mailboxId","mailbox","o","path","children","length","$mailboxes","$newMessage","encodeUriFilter","$state","Message","data","uid","messageId","toString","$account","$reload","$editableContent","runBlock","$rootScope","$on","event","current","previous","rejection","console","error","MessageEditorControllerPopup","$window","$mdDialog","show","hasBackdrop","disableParentScroll","clickOutsideToClose","escapeToClose","locals","stateRecipients","opener","close","module","config","run","$inject"],"mappings":"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","sourcesContent":["/* -*- Mode: javascript; indent-tabs-mode: nil; c-basic-offset: 2 -*- */\n/* JavaScript for SOGo.MailerUI module */\n\n(function() {\n  'use strict';\n\n  angular.module('SOGo.MailerUI', ['ngSanitize', 'ui.router', 'ck', 'angularFileUpload', 'SOGo.Common', 'SOGo.ContactsUI', 'ngAnimate', 'SOGo.PreferencesUI'])\n    .config(configure)\n    .run(runBlock)\n    .controller('MessageEditorControllerPopup', MessageEditorControllerPopup);\n\n  /**\n   * @ngInject\n   */\n  configure.$inject = ['$stateProvider', '$urlRouterProvider'];\n  function configure($stateProvider, $urlRouterProvider) {\n    $stateProvider\n      .state('mail', {\n        url: '/Mail',\n        abstract: true,\n        views: {\n          message: {\n            template: '<ui-view/>'\n          }\n        },\n        resolve: {\n          stateAccounts: stateAccounts\n        }\n      })\n      .state('mail.account', {\n        url: '/:accountId',\n        abstract: true,\n        template: '<ui-view id=\"account\"/>',\n        resolve: {\n          stateAccount: stateAccount\n        }\n      })\n      .state('mail.account.mailbox', {\n        url: '/:mailboxId',\n        abstract: true,\n        template: '<ui-view id=\"mailbox\"/>',\n        resolve: {\n          stateMailbox: stateMailbox\n        }\n      })\n      .state('mail.account.mailbox.newMessage', {\n        url: '/new',\n        views: {\n          'message@': {\n            template: '<ui-view/>',\n            controller: 'MessageEditorControllerPopup'\n          }\n        },\n        resolve: {\n          stateMessage: stateNewMessage\n        }\n      })\n      .state('mail.account.mailbox.message', {\n        url: '/:messageId',\n        views: {\n          'message@': {\n            templateUrl: 'UIxMailViewTemplate', // UI/Templates/MailerUI/UIxMailViewTemplate.wox\n            controller: 'MessageController',\n            controllerAs: 'viewer'\n          }\n        },\n        resolve: {\n          stateMessage: stateMessage\n        }\n      })\n      .state('mail.account.mailbox.message.edit', {\n        url: '/edit',\n        views: {\n          'message@': {\n            templateUrl: 'UIxMailEditor', // UI/Templates/MailerUI/UIxMailEditor.wox\n            controller: 'MessageEditorController',\n            controllerAs: 'editor'\n          }\n        },\n        resolve: {\n          stateContent: stateContent\n        }\n      })\n      .state('mail.account.mailbox.message.action', {\n        url: '/{actionName:(?:reply|replyall|forward)}',\n        views: {\n          message: {\n            templateUrl: 'UIxMailEditor', // UI/Templates/MailerUI/UIxMailEditor.wox\n            controller: 'MessageEditorController',\n            controllerAs: 'editor'\n          }\n        }\n      });\n\n    // if none of the above states are matched, use this as the fallback\n    $urlRouterProvider.otherwise('/Mail/0/folderINBOX/new');\n  }\n\n  /**\n   * @ngInject\n   */\n  stateAccounts.$inject = ['$q', 'Account'];\n  function stateAccounts($q, Account) {\n    var promise = Account.$findAll();\n    // Fetch list of mailboxes for each account\n    return promise.then(function(accounts) {\n      var promises = [];\n      angular.forEach(accounts, function(account, i) {\n        var mailboxes = account.$getMailboxes();\n        promises.push(mailboxes.then(function(objects) {\n          return account;\n        }));\n      });\n      return $q.all(promises);\n    });\n  }\n\n  /**\n   * @ngInject\n   */\n  stateAccount.$inject = ['$stateParams', 'stateAccounts'];\n  function stateAccount($stateParams, stateAccounts) {\n    return _.find(stateAccounts, function(account) {\n      return account.id == $stateParams.accountId;\n    });\n  }\n\n  /**\n   * @ngInject\n   */\n  stateMailbox.$inject = ['$stateParams', 'stateAccount', 'decodeUriFilter'];\n  function stateMailbox($stateParams, stateAccount, decodeUriFilter) {\n    var mailboxId = decodeUriFilter($stateParams.mailboxId),\n        _find;\n    // Recursive find function\n    _find = function(mailboxes) {\n      var mailbox = _.find(mailboxes, function(o) {\n        return o.path == mailboxId;\n      });\n      if (!mailbox) {\n        angular.forEach(mailboxes, function(o) {\n          if (!mailbox && o.children && o.children.length > 0) {\n            mailbox = _find(o.children);\n          }\n        });\n      }\n      return mailbox;\n    };\n    return _find(stateAccount.$mailboxes);\n  }\n\n  /**\n   * @ngInject\n   */\n  stateNewMessage.$inject = ['stateAccount'];\n  function stateNewMessage(stateAccount) {\n    return stateAccount.$newMessage();\n  }\n\n  /**\n   * @ngInject\n   */\n  stateMessage.$inject = ['encodeUriFilter', '$stateParams', '$state', 'stateMailbox', 'Message'];\n  function stateMessage(encodeUriFilter, $stateParams, $state, stateMailbox, Message) {\n    var data = { uid: $stateParams.messageId.toString() },\n        message = new Message(stateMailbox.$account.id, stateMailbox, data);\n\n    return message.$reload();\n  }\n\n  /**\n   * @ngInject\n   */\n  stateContent.$inject = ['stateMessage'];\n  function stateContent(stateMessage) {\n    return stateMessage.$editableContent();\n  }\n\n  /**\n   * @ngInject\n   */\n  runBlock.$inject = ['$rootScope'];\n  function runBlock($rootScope) {\n    $rootScope.$on('$routeChangeError', function(event, current, previous, rejection) {\n      console.error(event, current, previous, rejection);\n    });\n  }\n\n  /**\n   * @ngInject\n   */\n  MessageEditorControllerPopup.$inject = ['$window', '$mdDialog', 'stateAccounts', 'stateMessage'];\n  function MessageEditorControllerPopup($window, $mdDialog, stateAccounts, stateMessage) {\n    $mdDialog\n      .show({\n        hasBackdrop: false,\n        disableParentScroll: false,\n        clickOutsideToClose: false,\n        escapeToClose: false,\n        templateUrl: 'UIxMailEditor',\n        controller: 'MessageEditorController',\n        controllerAs: 'editor',\n        locals: {\n          stateAccounts: stateAccounts,\n          stateMessage: stateMessage,\n          stateRecipients: []\n        }\n      })\n      .finally(function() {\n        if ($window.opener)\n          $window.close();\n      });\n  }\n  \n})();\n"]}