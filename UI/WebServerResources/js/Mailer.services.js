!function(){"use strict";function a(b){"function"!=typeof b.then&&(angular.extend(this,b),_.forEach(this.identities,function(a){a.fullName?a.full=a.fullName+" <"+a.email+">":a.full="<"+a.email+">"}),a.$log.debug("Account: "+JSON.stringify(b,void 0,2)))}a.$factory=["$q","$timeout","$log","sgSettings","Resource","Preferences","Mailbox","Message",function(b,c,d,e,f,g,h,i){return angular.extend(a,{$q:b,$timeout:c,$log:d,$$resource:new f(e.activeUser("folderURL")+"Mail",e.activeUser()),$Preferences:g,$Mailbox:h,$Message:i}),a}];try{angular.module("SOGo.MailerUI")}catch(a){angular.module("SOGo.MailerUI",["SOGo.Common"])}angular.module("SOGo.MailerUI").factory("Account",a.$factory),a.$findAll=function(b){return b?a.$unwrapCollection(b):a.$$resource.fetch("","mailAccounts").then(function(b){return a.$unwrapCollection(b)})},a.$unwrapCollection=function(b){var c=[];return angular.forEach(b,function(b,d){b.id=d,c[d]=new a(b)}),a.$accounts=c,c},a.prototype.getLength=function(){return this.$flattenMailboxes().length},a.prototype.getItemAtIndex=function(a){var b;return b=this.$flattenMailboxes(),a>=0&&a<b.length?b[a]:null},a.prototype.$getMailboxes=function(b){var c=this;return!this.$mailboxes||b&&b.reload?a.$Mailbox.$find(this,b).then(function(b){c.$mailboxes=b,c.$expanded=!1;var d,e=function(a){_.forEach(a,function(a){a.$expanded=d.indexOf("/"+a.id)>=0,a.children&&a.children.length>0&&e(a.children)})};if(a.$Preferences.settings.Mail.ExpandedFolders){if(angular.isString(a.$Preferences.settings.Mail.ExpandedFolders))try{d=angular.fromJson(a.$Preferences.settings.Mail.ExpandedFolders)}catch(b){a.$log.warn("Can't parse list of expanded folders. String was: "+a.$Preferences.settings.Mail.ExpandedFolders),d=[]}else d=a.$Preferences.settings.Mail.ExpandedFolders;c.$expanded=d.indexOf("/"+c.id)>=0,d.length>0&&e(c.$mailboxes)}return a.$accounts&&(c.$expanded|=1==a.$accounts.length),c.$flattenMailboxes({reload:!0}),c.$mailboxes}):a.$q.when(this.$mailboxes)},a.prototype.$flattenMailboxes=function(b){var c=this,d=[],e=[],f=function(a){_.forEach(a,function(a){d.push(a),(b&&b.all||a.$expanded)&&a.children&&a.children.length>0&&f(a.children)})};return!this.$$flattenMailboxes||b&&(b.reload||b.all)?(f(this.$mailboxes),b&&b.all||(c.$$flattenMailboxes=d,b&&b.saveState&&(_.forEach(a.$accounts,function(a){a.$expanded&&e.push("/"+a.id),_.reduce(a.$$flattenMailboxes,function(a,b){return b.$expanded&&a.push("/"+b.id),a},e)}),a.$$resource.post(null,"saveFoldersState",e)))):d=this.$$flattenMailboxes,d},a.prototype.$getMailboxByType=function(a){var b,c=function(b){var d=_.find(b,function(b){return b.type==a});return d||angular.forEach(b,function(a){!d&&a.children&&a.children.length>0&&(d=c(a.children))}),d};return b=c(this.$mailboxes)},a.prototype.$getMailboxByPath=function(a){var b=null,c=function(b){var d=_.find(b,function(b){return b.path==a});return d||angular.forEach(b,function(a){!d&&a.children&&a.children.length>0&&(d=c(a.children))}),d};return b=c(this.$mailboxes)},a.prototype.$newMailbox=function(b,c){var d=this;return a.$$resource.post(b.toString(),"createFolder",{name:c}).then(function(){d.$getMailboxes({reload:!0})})},a.prototype.$certificate=function(){var b=this;return this.security&&this.security.hasCertificate?this.$$certificate?a.$q.when(this.$$certificate):a.$$resource.fetch(this.id.toString(),"certificate").then(function(a){return b.$$certificate=a,a}):a.$q.reject()},a.prototype.$removeCertificate=function(){var b=this;return a.$$resource.fetch(this.id.toString(),"removeCertificate").then(function(){b.security.hasCertificate=!1})},a.prototype.updateQuota=function(a){var b,c,d;b=Math.round(1e4*a.usedSpace/a.maxQuota)/100,c=l("quotasFormat"),d=c.formatted(b,Math.round(a.maxQuota/10.24)/100),this.$quota={percent:b,description:d}},a.prototype.$newMessage=function(b){var c=this;return a.$$resource.fetch(this.id.toString(),"compose").then(function(b){a.$log.debug("New message (compose): "+JSON.stringify(b,void 0,2));var d=new a.$Message(b.accountId,c.$getMailboxByPath(b.mailboxPath),b);return d}).then(function(d){return a.$$resource.fetch(d.$absolutePath({asDraft:!0}),"edit").then(function(e){var f=a.$Preferences.defaults.AuxiliaryMailAccounts[c.id];return f.security&&(f.security.alwaysSign&&(e.sign=!0),f.security.alwaysEncrypt&&(e.encrypt=!0)),a.$log.debug("New message (edit): "+JSON.stringify(e,void 0,2)),angular.extend(d.editable,e),d.isNew=!0,b&&b.mailto&&(angular.isObject(b.mailto)?angular.extend(d.editable,b.mailto):d.$parseMailto(b.mailto)),d})})},a.prototype.$addDelegate=function(b){var c=this,d=a.$q.defer(),e={uid:b.uid};return!b.uid||_.indexOf(_.map(this.delegates,"uid"),b.uid)>-1?d.resolve():a.$$resource.fetch(this.id.toString(),"addDelegate",e).then(function(){c.delegates.push(b),d.resolve(c.users)},function(a,b){d.reject(l("An error occured please try again."))}),d.promise},a.prototype.$removeDelegate=function(b){var c=this,d={uid:b};return a.$$resource.fetch(this.id.toString(),"removeDelegate",d).then(function(){var a=_.indexOf(_.map(c.delegates,"uid"),b);a>=0&&c.delegates.splice(a,1)})}}(),function(){"use strict";function a(b,c){if(this.$account=b,"function"!=typeof c.then){if(this.init(c),this.name&&!this.path){var d=a.$$resource.create("createFolder",this.name);this.$unwrap(d)}}else this.$unwrap(c)}a.$factory=["$q","$timeout","$log","sgSettings","Resource","Message","Acl","Preferences","sgMailbox_PRELOAD",function(b,c,d,e,f,g,h,i,j){return angular.extend(a,{$q:b,$timeout:c,$log:d,$$resource:new f(e.activeUser("folderURL")+"Mail",e.activeUser()),$Message:g,$$Acl:h,$Preferences:i,$query:{sort:"arrival",asc:0},selectedFolder:null,$refreshTimeout:null,$virtualMode:!1,$virtualPath:!1,PRELOAD:j}),i.settings.Mail.SortingState&&(a.$query.sort=i.settings.Mail.SortingState[0],a.$query.asc=parseInt(i.settings.Mail.SortingState[1])),a}];try{angular.module("SOGo.MailerUI")}catch(a){angular.module("SOGo.MailerUI",["SOGo.Common"])}angular.module("SOGo.MailerUI").constant("sgMailbox_PRELOAD",{LOOKAHEAD:50,SIZE:100}).factory("Mailbox",a.$factory),a.$find=function(b,c){var d;return d=c&&c.all?this.$$resource.fetch(b.id.toString(),"viewAll"):this.$$resource.fetch(b.id.toString(),"view"),a.$unwrapCollection(b,d)},a.$unwrapCollection=function(b,c){var d=[],e=function(c,d){for(var f=0;f<d.children.length;f++)d.children[f].level=c,d.children[f]=new a(b,d.children[f]),e(c+1,d.children[f])};return c.then(function(c){return a.$timeout(function(){return angular.forEach(c.mailboxes,function(c,f){c.level=0;var g=new a(b,c);e(1,g),d.push(g)}),c.quotas&&b.updateQuota(c.quotas),d})})},a.$absolutePath=function(a,b){var c=[];return b&&(c=_.map(b.split("/"),function(a){return"folder"+a.asCSSIdentifier()})),c.splice(0,0,a),c.join("/")},a.prototype.init=function(b){(angular.isUndefined(this.uidsMap)||b.headers)&&(this.$isLoading=!0,this.$messages=[],this.uidsMap={}),angular.extend(this,b),this.path&&(this.id=this.$id(),this.$acl=new a.$$Acl("Mail/"+this.id)),this.$displayName=this.name,this.type&&(this.$isEditable=this.isEditable(),this.$isSpecial=!0,"inbox"==this.type?(this.$displayName=l("InboxFolderName"),this.$icon="inbox"):"draft"==this.type?(this.$displayName=l("DraftsFolderName"),this.$icon="drafts"):"sent"==this.type?(this.$displayName=l("SentFolderName"),this.$icon="send"):"trash"==this.type?(this.$displayName=l("TrashFolderName"),this.$icon="delete"):"junk"==this.type?(this.$displayName=l("JunkFolderName"),this.$icon="thumb_down"):"additional"==this.type?this.$icon="folder_shared":(this.$isSpecial=!1,this.$icon="folder_open")),this.$isNoInferiors=this.isNoInferiors(),angular.isUndefined(this.$shadowData)&&(this.$shadowData=this.$omit())},a.prototype.selectFolder=function(){a.$virtualMode||(a.selectedFolder=this)},a.prototype.getLength=function(){return this.$messages.length},a.prototype.getItemAtIndex=function(a){var b;return a>=0&&a<this.$messages.length&&(b=this.$messages[a],this.$lastVisibleIndex=Math.max(0,a-3),this.$loadMessage(b.uid))?b:null},a.prototype.$id=function(){return a.$absolutePath(this.$account.id,this.path)},a.prototype.$selectedMessages=function(){return _.filter(this.$messages,function(a){return a.selected})},a.prototype.$selectedCount=function(){return this.$selectedMessages().length},a.prototype.isSelectedMessage=function(a){return this.selectedMessage==a},a.prototype.$selectedMessage=function(){var a=this;return _.find(this.$messages,function(b){return b.uid==a.selectedMessage})},a.prototype.$selectedMessageIndex=function(){return this.uidsMap[this.selectedMessage]},a.prototype.hasSelectedMessage=function(){return angular.isDefined(this.selectedMessage)},a.prototype.$filter=function(b,c){var d=this,e={};if(angular.isDefined(this.unseenCount)||(this.unseenCount=0),a.$timeout(function(){d.$isLoading=!0}),a.$refreshTimeout&&a.$timeout.cancel(a.$refreshTimeout),b&&angular.extend(a.$query,b),angular.extend(e,{sortingAttributes:a.$query}),angular.isDefined(c)&&(e.filters=_.reject(c,function(a){return!a.searchInput||0===a.searchInput.length}),_.forEach(e.filters,function(a){var b,c=a.searchBy.match(/(\w+)_or_(\w+)/);c&&(e.sortingAttributes.match="OR",a.searchBy=c[1],b=angular.copy(a),b.searchBy=c[2],e.filters.push(b))})),!a.$virtualMode){var f=a.$Preferences.defaults.SOGoRefreshViewCheck;if(f&&"manually"!=f){var g=angular.bind(this,a.prototype.$filter,null,c);a.$refreshTimeout=a.$timeout(g,1e3*f.timeInterval())}}var h=a.$$resource.post(this.id,"view",e);return this.$unwrap(h)},a.prototype.$loadMessage=function(b){var c,d,e,f,g=this.uidsMap[b],h=this.$messages.length,i=!1;if(angular.isDefined(this.uidsMap[b])&&g<this.$messages.length&&(angular.isDefined(this.$messages[g].subject)&&(i=!0),c=Math.min(g+a.PRELOAD.LOOKAHEAD,h-1),angular.isDefined(this.$messages[c].subject)||angular.isDefined(this.$messages[c].loading)?(d=Math.max(g-a.PRELOAD.LOOKAHEAD,0),angular.isDefined(this.$messages[d].subject)||angular.isDefined(this.$messages[d].loading)||(c=g,g=Math.max(g-a.PRELOAD.SIZE,0))):c=Math.min(g+a.PRELOAD.SIZE,h-1),!angular.isDefined(this.$messages[g].subject)&&!angular.isDefined(this.$messages[g].loading)||!angular.isDefined(this.$messages[c].subject)&&!angular.isDefined(this.$messages[c].loading))){for(e=[];g<c&&g<h;g++)angular.isDefined(this.$messages[g].subject)||this.$messages[g].loading?c++:(e.push(this.$messages[g].uid),this.$messages[g].loading=!0);a.$log.debug("Loading UIDs "+e.join(" ")),f=a.$$resource.post(this.id,"headers",{uids:e}),this.$unwrapHeaders(f)}return i},a.prototype.isEditable=function(){return"folder"==this.type},a.prototype.isNoInferiors=function(){return this.flags.indexOf("noinferiors")>=0},a.prototype.isNoSelect=function(){return this.flags.indexOf("noselect")>=0},a.prototype.getClassName=function(a){return!1},a.prototype.$rename=function(){var b,c,d,e,f=this;return this.name==this.$shadowData.name?a.$q.when():(b=function(a,c){var d=null,e=_.find(c,function(a){return a.path==f.path});return e?d=a:angular.forEach(c,function(a){!d&&a.children&&a.children.length>0&&(d=b(a,a.children))}),d},c=b(null,this.$account.$mailboxes),d=null===c?this.$account.$mailboxes:c.children,e=_.indexOf(_.map(d,"id"),this.id),this.$save().then(function(a){var b,c=f.path;f.init(a),d.splice(e,1),b=_.find(d,function(a){return"folder"==a.type&&a.name.localeCompare(f.name)>0}),e=b?_.indexOf(_.map(d,"id"),b.id):d.length,d.splice(e,0,f);var g=new RegExp("^"+c),h=function(a){_.forEach(a.children,function(a){a.path=a.path.replace(g,f.path),a.id=a.$id(),h(a)})};h(f)}))},a.prototype.$compact=function(){var b=this;return a.$$resource.post(this.id,"expunge").then(function(a){a.quotas&&b.$account.updateQuota(a.quotas)})},a.prototype.$canFolderAs=function(){return"folder"==this.type&&0===this.level},a.prototype.$setFolderAs=function(b){return a.$$resource.post(this.id,"setAs"+b+"Folder")},a.prototype.$emptyTrash=function(){var b=this;return a.$$resource.post(this.id,"emptyTrash").then(function(a){b.$messages=[],b.uidsMap={},b.unseenCount=0,angular.isDefined(b.children)&&b.children.length&&b.$account.$getMailboxes({reload:!0}),a.quotas&&b.$account.updateQuota(a.quotas)})},a.prototype.$markAsRead=function(){var b=this;return a.$$resource.post(this.id,"markRead").then(function(){b.unseenCount=0,_.forEach(b.$messages,function(a){a.isread=!0})})},a.prototype.$flagMessages=function(b,c,d){var e={msgUIDs:_.map(b,"uid"),flags:c,operation:d};return a.$$resource.post(this.id,"addOrRemoveLabel",e).then(function(){return b})},a.prototype.saveSelectedMessages=function(){var b,c,d,e;return d=_.filter(this.$messages,function(a){return a.selected}),e=_.map(d,"uid"),b={uids:e},c={filename:l("Saved Messages.zip")},a.$$resource.download(this.id,"saveMessages",{uids:e})},a.prototype.exportFolder=function(){var b;return b={filename:this.name+".zip"},a.$$resource.download(this.id,"exportFolder",null,b)},a.prototype.$delete=function(b){var c=this;return a.$$resource.post(this.id,"delete",b).then(function(){return c.$account.$getMailboxes({reload:!0}),!0})},a.prototype.$_deleteMessages=function(a,b){var c,d=this,e=this.$messages.length;return c=_.filter(b,function(a,b){return!a.isread}),this.unseenCount-=c.length,_.forEachRight(this.$messages,function(b,c){var f=_.findIndex(a,function(a){return b.uid==a});f>-1?(a.splice(f,1),delete d.uidsMap[b.uid],b.uid==d.selectedMessage&&delete d.selectedMessage,d.$messages.splice(c,1),c<e&&(e=c)):d.uidsMap[b.uid]-=a.length}),e},a.prototype.$deleteMessages=function(b,c){var d,e,f=this;return d=_.map(b,"uid"),e={uids:d},c&&angular.extend(e,c),a.$$resource.post(this.id,"batchDelete",e).then(function(a){return a.quotas&&f.$account.updateQuota(a.quotas),f.$_deleteMessages(d,b)})},a.prototype.$markOrUnMarkMessagesAsJunk=function(b){var c=_.map(b,"uid"),d="junk"==this.type?"markMessagesAsNotJunk":"markMessagesAsJunk";return a.$$resource.post(this.id,d,{uids:c})},a.prototype.$copyMessages=function(b,c){var d=this,e=_.map(b,"uid");return a.$$resource.post(this.id,"copyMessages",{uids:e,folder:c}).then(function(a){a.quotas&&d.$account.updateQuota(a.quotas)})},a.prototype.$moveMessages=function(b,c){var d,e=this;return d=_.map(b,"uid"),a.$$resource.post(this.id,"moveMessages",{uids:d,folder:c}).then(function(){return e.$_deleteMessages(d,b)})},a.prototype.$reset=function(){var a=this;angular.forEach(this.$shadowData,function(b,c){delete a[c]}),angular.extend(this,this.$shadowData),this.$shadowData=this.$omit()},a.prototype.$save=function(){var b=this;return a.$$resource.save(this.id,this.$omit()).then(function(c){return b.$shadowData=b.$omit(),a.$log.debug(JSON.stringify(c,void 0,2)),c},function(c){return a.$log.error(JSON.stringify(c.data,void 0,2)),b.$reset(),c.data})},a.prototype.$newMailbox=function(a,b){return this.$account.$newMailbox(a,b)},a.prototype.$omit=function(){var a={};return angular.forEach(this,function(b,c){"constructor"!=c&&"children"!=c&&"headers"!=c&&"uids"!=c&&"uidsMap"!=c&&"$"!=c[0]&&(a[c]=b)}),a},a.prototype.$unwrap=function(b){var c=this,d=a.$q.defer();return this.$futureMailboxData=b,this.$futureMailboxData.then(function(b){var e=_.map(c.$selectedMessages(),"uid");a.$timeout(function(){var f,g;(!b.uids||c.$topIndex>b.uids.length-1)&&(c.$topIndex=0),c.init(b),c.uids&&(a.$log.debug("unwrapping "+c.uids.length+" messages"),g=_.invokeMap(c.headers[0],"toLowerCase"),c.headers.splice(0,1),c.threaded&&(f=c.uids[0],c.uids.splice(0,1)),_.reduce(c.uids,function(b,d,g){var h,i;return h=c.threaded?_.zipObject(f,d):{uid:d.toString()},c.uidsMap[h.uid]=g,i=new a.$Message(c.$account.id,c,h,!0),i.selected=e.indexOf(i.uid)>-1,b.push(i),b},c.$messages),_.forEach(c.headers,function(a){var b=_.zipObject(g,a),d=c.uidsMap[b.uid.toString()];_.extend(c.$messages[d],b)})),a.$log.debug("mailbox "+c.id+" ready"),c.$isLoading=!1,d.resolve(c.$messages)})},function(a){angular.extend(c,a),c.isError=!0,c.$isLoading=!1,d.reject()}),d.promise},a.prototype.$unwrapHeaders=function(b){var c=this;b.then(function(b){a.$timeout(function(){var a,d;b.length>0&&(a=_.invokeMap(b[0],"toLowerCase"),b.splice(0,1),_.forEach(b,function(b){b=_.zipObject(a,b),d=c.uidsMap[b.uid.toString()],angular.isDefined(d)&&_.extend(c.$messages[d],b)}))})})},a.prototype.$updateSubscribe=function(){var b=this.subscribed?"subscribe":"unsubscribe";a.$$resource.post(this.id,b)}}(),function(){"use strict";function a(a,b,c,d){this.accountId=a,this.$mailbox=b,this.$hasUnsafeContent=!1,this.$loadUnsafeContent=!1,this.editable={to:[],cc:[],bcc:[]},this.selected=!1,"function"!=typeof c.then?(!angular.isUndefined(d)&&d||(angular.extend(this,c),this.$formatFullAddresses()),this.uid=parseInt(c.uid)):this.$unwrap(c)}a.$factory=["$q","$timeout","$log","sgSettings","sgMessage_STATUS","Resource","Preferences",function(b,c,d,e,f,g,h){return angular.extend(a,{STATUS:f,$q:b,$timeout:c,$log:d,$$resource:new g(e.activeUser("folderURL")+"Mail",e.activeUser()),$Preferences:h,$avatar:angular.bind(h,h.avatar)}),h.defaults.SOGoMailLabelsColors&&(a.$tags=h.defaults.SOGoMailLabelsColors),h.defaults.SOGoMailDisplayRemoteInlineImages&&"always"==h.defaults.SOGoMailDisplayRemoteInlineImages&&(a.$displayRemoteInlineImages=!0),a}];try{angular.module("SOGo.MailerUI")}catch(a){angular.module("SOGo.MailerUI",["SOGo.Common"])}angular.module("SOGo.MailerUI").constant("sgMessage_STATUS",{NOT_LOADED:0,DELAYED_LOADING:1,LOADING:2,LOADED:3,DELAYED_MS:300}).factory("Message",a.$factory),a.filterTags=function(b,c){var d=new RegExp(b,"i"),e=[];return _.forEach(_.keys(a.$tags),function(b){var f=a.$tags[b];f[0].search(d)!=-1&&(_.includes(c,b)||e.push({name:b,description:f[0],color:f[1]}))}),e},a.prototype.$absolutePath=function(b){function c(){var a;return a=_.map(d.$mailbox.path.split("/"),function(a){return"folder"+a.asCSSIdentifier()}),a.splice(0,0,d.accountId),a.join("/")}var d=this,e=this.id;return(angular.isUndefined(this.id)||b&&b.nocache)&&(this.id=c()+"/"+this.uid,e=this.id),b&&b.asDraft&&this.draftId&&(e=c()+"/"+this.draftId),b&&b.withResourcePath&&(e=a.$$resource.path(e)),e},a.prototype.$setUID=function(a){var b,c=this.uid||-1,d=this;c!=parseInt(a)&&(this.uid=parseInt(a),this.$absolutePath({nocache:!0}),c>-1?(c=c.toString(),angular.isDefined(this.$mailbox.uidsMap[c])&&(b=this.$mailbox.uidsMap[c],this.$mailbox.uidsMap[a]=b,delete this.$mailbox.uidsMap[c],_.forEach(["from","to","subject"],function(a){d.$mailbox.$messages[b][a]=d[a]}))):this.$mailbox.constructor.selectedFolder&&"draft"==this.$mailbox.constructor.selectedFolder.type&&this.$mailbox.constructor.selectedFolder.$filter())},a.prototype.$formatFullAddresses=function(){var b=this,c=_.map(b.$mailbox.$account.identities,"email");_.forEach(["from","to","cc","bcc","reply-to"],function(d){_.forEach(b[d],function(b){b.name&&b.name!=b.email?(b.full=b.name+" <"+b.email+">",b.name.length<10?b.shortname=b.name:b.name.split(" ").length&&(b.shortname=_.first(_.last(b.name.split(/, */)).split(/ +/)).replace("'",""))):b.email&&(b.full="<"+b.email+">",b.shortname=b.email.split("@")[0]),b.image=a.$avatar(b.email,32),_.indexOf(c,b.email)>=0&&(b.shortname=l("me"))})})},a.prototype.$shortRecipients=function(a){var b=this,c=[],d=0,e=0;return _.forEach(["to","cc","bcc"],function(f){e+=b[f]?b[f].length:0,_.forEach(b[f],function(b,e){d<a&&c.push(b.shortname),d++})}),e>a&&c.push(l("and %{0} more...",e-a)),c.join(", ")},a.prototype.$shortAddress=function(a){var b="";return this[a]&&this[a].length>0&&(b=this[a][0].name||this[a][0].email||""),b},a.prototype.allowReplyAll=function(){var a=0;return a=_.reduce(["to","cc"],_.bind(function(a,b){return this[b]?a+this[b].length:a},this),a),!this.isDraft&&a>1},a.prototype.loadUnsafeContent=function(){this.$loadUnsafeContent=!0,delete this.$parts},a.prototype.$content=function(){var b=this,c=[],d=function(e){e.msgclass="msg-attachment-other","UIxMailPartAlternativeViewer"==e.type?d(_.find(e.content,function(a){return e.preferredPart==a.contentType})):angular.isArray(e.content)?("UIxMailPartSignedViewer"==e.type&&1===e["supports-smime"]?b.signed={valid:e.valid,certificate:e.certificates[e.certificates.length-1],message:e.message}:"UIxMailPartEncryptedViewer"==e.type&&(b.encrypted={valid:e.valid},e.valid?b.encrypted.message=l("This message is encrypted"):b.encrypted.message=l("This message can't be decrypted. Please make sure you have uploaded your S/MIME certificate from the mail preferences module.")),_.forEach(e.content,function(a){d(a)})):(angular.isUndefined(e.safeContent)&&(e.safeContent=e.content,b.$hasUnsafeContent|=e.safeContent.indexOf(" unsafe-")>-1),"UIxMailPartHTMLViewer"==e.type?(e.html=!0,b.$loadUnsafeContent||a.$displayRemoteInlineImages?(angular.isUndefined(e.unsafeContent)&&(e.unsafeContent=document.createElement("div"),e.unsafeContent.innerHTML=e.safeContent,angular.forEach(["src","data","classid","background","style"],function(a){var b,c,d,f=e.unsafeContent.querySelectorAll("[unsafe-"+a+"]");for(d=0;d<f.length;d++)b=angular.element(f[d]),c=b.attr("unsafe-"+a),b.attr(a,c),b.removeAttr("unsafe-"+a)}),b.$hasUnsafeContent=!1),e.content=e.unsafeContent.innerHTML):e.content=e.safeContent,c.push(e)):"UIxMailPartICalViewer"==e.type||"UIxMailPartImageViewer"==e.type||"UIxMailPartLinkViewer"==e.type?("UIxMailPartImageViewer"==e.type?e.msgclass="msg-attachment-image":"UIxMailPartLinkViewer"==e.type&&(e.msgclass="msg-attachment-link"),e.compile=!0,c.push(e)):(e.html=!0,e.content=e.safeContent,c.push(e)))};return this.$parts?this.$parts:(this.parts&&d(this.parts),this.$parts=c,c)},a.prototype.$editableContent=function(){var b=this;return a.$$resource.fetch(this.$absolutePath(),"edit").then(function(c){return angular.extend(b,c),a.$$resource.fetch(b.$absolutePath({asDraft:!0}),"edit").then(function(c){var d=_.find(b.$mailbox.$account.identities,function(a){return c.from.toLowerCase().indexOf(a.email)!==-1});d&&(c.from=d.full);var e=a.$Preferences.defaults.AuxiliaryMailAccounts[b.$mailbox.$account.id];return e.security&&(e.security.alwaysSign&&(c.sign=!0),e.security.alwaysEncrypt&&(c.encrypt=!0)),a.$log.debug("editable = "+JSON.stringify(c,void 0,2)),angular.extend(b.editable,c),c.text})})},a.prototype.$plainContent=function(){return a.$$resource.fetch(this.$absolutePath(),"viewplain")},a.prototype.addTag=function(a){return this.$addOrRemoveTag("add",a)},a.prototype.removeTag=function(a){return this.$addOrRemoveTag("remove",a)},a.prototype.$addOrRemoveTag=function(b,c){var d={operation:b,msgUIDs:[this.uid],flags:c};if(c)return a.$$resource.post(this.$mailbox.$id(),"addOrRemoveLabel",d)},a.prototype.$imipAction=function(b,c,d){var e=this;a.$$resource.post([this.$absolutePath(),b].join("/"),c,d).then(function(b){a.$timeout(function(){e.$reload()})})},a.prototype.$sendMDN=function(){return this.shouldAskReceipt=0,a.$$resource.post(this.$absolutePath(),"sendMDN")},a.prototype.$deleteAttachment=function(b){var c={filename:b},d=this;a.$$resource.fetch(this.$absolutePath({asDraft:!0}),"deleteAttachment",c).then(function(c){a.$timeout(function(){d.editable.attachmentAttrs=_.filter(d.editable.attachmentAttrs,function(a){return a.filename!=b})})})},a.prototype.toggleFlag=function(){var b=this,c="markMessageFlagged";return this.isflagged&&(c="markMessageUnflagged"),a.$$resource.post(this.$absolutePath(),c).then(function(c){a.$timeout(function(){b.isflagged=!b.isflagged})})},a.prototype.$isLoading=function(){return this.$loaded==a.STATUS.LOADING},a.prototype.$reload=function(b){var c,d=this;return b&&b.useCache&&this.$futureMessageData?(this.isread||a.$$resource.fetch(this.$absolutePath(),"markMessageRead").then(function(){a.$timeout(function(){d.isread=!0,d.$mailbox.unseenCount--})}),this):(c=a.$$resource.fetch(this.$absolutePath(b),"view"),this.$unwrap(c))},a.prototype.$parseMailto=function(a){var b,c,d=/^mailto:([^\?]+)/.exec(a);d&&(b=_.map(decodeURIComponent(d[1]).split(","),function(a){return"<"+a.trim()+">"}),c={to:b},_.forEach(["subject","body"],function(b){var e=new RegExp(b+"=([^&]+)");b="body"==b?"text":b,d=e.exec(a),d&&(c[b]=decodeURIComponent(d[1]))}),_.forEach(["cc","bcc"],function(b){var e=new RegExp(b+"=([^&]+)");d=e.exec(a),d&&(c[b]=_.map(decodeURIComponent(d[1]).split(","),function(a){return"<"+a.trim()+">"}))}),angular.extend(this.editable,c))},a.prototype.$reply=function(){return this.$newDraft("reply")},a.prototype.$replyAll=function(){return this.$newDraft("replyall")},a.prototype.$forward=function(){return this.$newDraft("forward")},a.prototype.$newDraft=function(b){var c=this;return a.$$resource.fetch(this.$absolutePath(),b).then(function(d){var e,f;return a.$log.debug("New "+b+": "+JSON.stringify(d,void 0,2)),e=c.$mailbox.$account.$getMailboxByPath(d.mailboxPath),f=new a(d.accountId,e,d),a.$$resource.fetch(f.$absolutePath({asDraft:!0}),"edit").then(function(d){a.$log.debug("New "+b+": "+JSON.stringify(d,void 0,2)+" original UID: "+c.uid);var e=a.$Preferences.defaults.AuxiliaryMailAccounts[c.$mailbox.$account.id];return e.security&&(e.security.alwaysSign&&(d.sign=!0),e.security.alwaysEncrypt&&(d.encrypt=!0)),angular.extend(f.editable,d),f.origin={message:c,action:b},f})})},a.prototype.$save=function(){var b=this,c=this.editable;return a.$log.debug("save = "+JSON.stringify(c,void 0,2)),a.$$resource.save(this.$absolutePath({asDraft:!0}),c).then(function(c){a.$log.debug("save = "+JSON.stringify(c,void 0,2)),b.$setUID(c.uid),b.$reload(),b.isNew=!1})},a.prototype.$send=function(){var b=this,c=angular.copy(this.editable);return a.$log.debug("send = "+JSON.stringify(c,void 0,2)),a.$$resource.post(this.$absolutePath({asDraft:!0}),"send",c).then(function(c){return"success"==c.status?(angular.isDefined(b.origin)&&(b.origin.action.startsWith("reply")?b.origin.message.isanswered=!0:"forward"==b.origin.action&&(b.origin.message.isforwarded=!0)),c):a.$q.reject(c.data)})},a.prototype.$unwrap=function(b){var c=this;return this.$loaded=a.STATUS.DELAYED_LOADING,a.$timeout(function(){c.$loaded!=a.STATUS.LOADED&&(c.$loaded=a.STATUS.LOADING)},a.STATUS.DELAYED_MS),this.$futureMessageData=b.then(function(b){return 0===c.isread&&(c.isread=!0,c.$mailbox.unseenCount--),a.$timeout(function(){return delete c.$parts,angular.extend(c,b),c.$formatFullAddresses(),c.$loadUnsafeContent=!1,c.$loaded=a.STATUS.LOADED,c})}),this.$futureMessageData},a.prototype.$omit=function(a){var b={},c=a&&a.privateAttributes;return angular.forEach(this,function(a,d){("constructor"!=d&&"$"!=d[0]||c)&&(b[d]=a)}),b},a.prototype.download=function(){var b,c;return b={uids:[this.uid]},c={filename:this.subject+".zip"},a.$$resource.download(this.$mailbox.id,"saveMessages",b,c)},a.prototype.downloadAttachments=function(){var b;return b={filename:l("attachments")+"-"+this.uid+".zip"},a.$$resource.download(this.$absolutePath(),"archiveAttachments",null,b)}}(),function(){"use strict";function a(){this.show=!1,this.message=null,this.elements=[]}a.$factory=["$document","$timeout","$mdPanel","sgHotkeys",function(b,c,d,e){return angular.extend(a,{$document:b,$timeout:c,$mdPanel:d,sgHotkeys:e}),new a}],a.prototype.setMessage=function(a){this.message=a},a.prototype.registerImage=function(a){this.elements.push(a)},a.prototype.registerHotkeys=function(b){this.keys=[a.sgHotkeys.createHotkey({key:"left",description:l("View previous item"),callback:angular.bind(b,b.previousImage)}),a.sgHotkeys.createHotkey({key:"right",description:l("View next item"),callback:angular.bind(b,b.nextImage)})],_.forEach(this.keys,function(b){a.sgHotkeys.registerHotkey(b)})},a.prototype.showGallery=function(b,c){function d(a){a.$ctrl=this,this.close=function(){a.close()},this.selectImage=function(a){this.selectedIndex=a,this.selectedImage=this.images[a]},this.nextImage=function(){this.selectedIndex!=this.lastIndex&&this.selectImage(this.selectedIndex+1)},this.previousImage=function(){this.selectedIndex>0&&this.selectImage(this.selectedIndex-1)}}var e=this,f=a.$mdPanel,g=angular.element(this.message.$content()[c].content).find("img")[0].src,h=_.filter(this.message.attachmentAttrs,function(a){return 0===a.mimetype.indexOf("image/")}),i=_.findIndex(h,function(a){return a.url.indexOf(g)>=0});angular.element(a.$document[0].body).addClass("sg-image-gallery-backdrop");var j=f.newPanelPosition().absolute(),k=f.newPanelAnimation().openFrom(b.target).duration(100).withAnimation(f.animation.FADE),m={attachTo:angular.element(document.body),locals:{lastIndex:h.length-1,images:h,selectedIndex:i,selectedImage:h[i]},bindToController:!0,controller:d,controllerAs:"$panelCtrl",position:j,animation:k,targetEvent:b,fullscreen:!0,hasBackdrop:!0,template:['<sg-image-gallery layout="column">','  <div class="md-toolbar-tools" layout="row" layout-align="space-between center">','    <md-button class="md-icon-button"','                aria-label="'+l("Close")+'"','                ng-click="$panelCtrl.close()">',"      <md-icon>arrow_back</md-icon>","    </md-button>",'    <md-icon class="md-primary">image</md-icon>','    <div md-truncate class="md-flex" ng-bind="$panelCtrl.selectedImage.filename"></div>','    <md-button class="md-icon-button"','                aria-label="'+l("Save Attachment")+'"','                ng-href="{{$panelCtrl.selectedImage.urlAsAttachment}}">',"      <md-icon>file_download</md-icon>","    </md-button>","  </div>",'  <div class="md-flex" layout="row" layout-align="space-between center">','      <md-button class="md-icon-button" ng-click="$panelCtrl.previousImage()"','                 ng-disabled="$panelCtrl.selectedIndex == 0">',"        <md-icon>navigate_before</md-icon>","      </md-button>",'      <img class="sg-image" ng-src="{{$panelCtrl.selectedImage.url}}">','      <md-button class="md-icon-button" ng-click="$panelCtrl.nextImage()"','                 ng-disabled="$panelCtrl.selectedIndex == $panelCtrl.lastIndex">',"        <md-icon>navigate_next</md-icon>","      </md-button>","  </div>",'    <div class="sg-image-thumbnails">','      <div class="sg-image-thumbnail" ng-repeat="image in ::$panelCtrl.images">','        <img class="sg-hide" ng-src="{{::image.url}}" ng-click="$panelCtrl.selectImage($index)">',"      </div>","    </div>","</sg-image-gallery>"].join(""),trapFocus:!0,clickOutsideToClose:!0,escapeToClose:!0,focusOnOpen:!0,onOpenComplete:function(){e.show=!0,_.forEach(a.$document.find("sg-image-gallery")[0].getElementsByClassName("sg-image-thumbnail"),function(b){var c=b.children[0];angular.element(c).one("load",function(){c.naturalWidth<c.naturalHeight&&c.classList.add("portrait")}),a.$timeout(function(){c.classList.remove("sg-hide")},1e3)})},onDomRemoved:function(){angular.element(a.$document[0].body).removeClass("sg-image-gallery-backdrop"),e.show=!1,_.forEach(e.hotkeys,function(b){a.sgHotkeys.deregisterHotkey(b)})}};f.open(m).then(function(a){e.registerHotkeys(a.$ctrl)}),d.$inject=["mdPanelRef"]},angular.module("SOGo.MailerUI").factory("ImageGallery",a.$factory)}(),function(){"use strict";function a(a){this.$account=a}a.$factory=["$q","$timeout","$log","sgSettings","Resource","Message","Mailbox","sgMailbox_PRELOAD",function(b,c,d,e,f,g,h,i){return angular.extend(a,{$q:b,$timeout:c,$log:d,$$resource:new f(e.activeUser("folderURL")+"Mail",e.activeUser()),$Message:h,selectedFolder:null,PRELOAD:i}),a}];try{angular.module("SOGo.MailerUI")}catch(a){angular.module("SOGo.MailerUI",["SOGo.Common"])}angular.module("SOGo.MailerUI").constant("sgMailbox_PRELOAD",{LOOKAHEAD:50,SIZE:100}).factory("VirtualMailbox",a.$factory),a.$absolutePath=function(a){return[a,"virtual"].join("/")},a.prototype.init=function(a){this.$isLoading=!1,this.$mailboxes=[],this.uidsMap={},angular.extend(this,a),this.id=this.$id()},a.prototype.setMailboxes=function(a){this.$mailboxes=a,_.forEach(this.$mailboxes,function(a){a.$messages=[],a.uidsMap={}})},a.prototype.startSearch=function(b,c){var d=this,e=a.$q.when();this.$isLoading=!0,_.forEach(this.$mailboxes,function(f){e=e.then(function(){if(d.$isLoading)return a.$log.debug("searching mailbox "+f.path),f.$filter({sort:"date",asc:!1,match:b},c)})}),e.finally(function(){d.$isLoading=!1})},a.prototype.stopSearch=function(){a.$log.debug("stopping search..."),this.$isLoading=!1},a.prototype.selectFolder=function(){},a.prototype.resetSelectedMessage=function(){_.forEach(this.$mailboxes,function(a){
delete a.selectedMessage})},a.prototype.hasSelectedMessage=function(){return angular.isDefined(_.find(this.$mailboxes,function(a){return angular.isDefined(a.selectedMessage)}))},a.prototype.isSelectedMessage=function(a,b){return angular.isDefined(_.find(this.$mailboxes,function(c){return c.path==b&&c.selectedMessage==a}))},a.prototype.getLength=function(){var a=0;return angular.isDefined(this.$mailboxes)?(_.forEach(this.$mailboxes,function(b){a+=b.$messages.length}),a):a},a.prototype.getItemAtIndex=function(a){var b,c,d,e,f;if(angular.isDefined(this.$mailboxes)&&a>=0)for(b=0,c=0;c<this.$mailboxes.length;c++)for(e=this.$mailboxes[c],d=0;d<e.$messages.length;b++,d++)if(f=e.$messages[d],b==a&&e.$loadMessage(f.uid))return f;return null},a.prototype.$id=function(){return a.$absolutePath(this.$account.id)},a.prototype.$selectedMessages=function(){return _.transform(this.$mailboxes,function(a,b){a[b.id]=b.$selectedMessages()},{})},a.prototype.$selectedCount=function(){return _.sum(_.invokeMap(this.$mailboxes,"$selectedCount"))},a.prototype.$flagMessages=function(b,c,d){var e={flags:c,operation:d},f=[],g=[];return _.forEach(b,function(b,c){if(b.length>0){var d=_.map(b,"uid");f.push(b);var h=a.$$resource.post(c,"addOrRemoveLabel",_.assign(e,{msgUIDs:d}));g.push(h)}}),a.$q.all(g).then(function(){return _.flatten(f)})},a.prototype.$deleteMessages=function(b){var c=[];return _.forEach(b,function(a,b){if(a.length>0){var d=a[0].$mailbox,e=d.$deleteMessages(a);c.push(e)}}),a.$q.all(c)},a.prototype.$markOrUnMarkMessagesAsJunk=function(b){var c=[];return _.forEach(b,function(a,b){if(a.length>0){var d=a[0].$mailbox,e=d.$markOrUnMarkMessagesAsJunk(a);c.push(e)}}),a.$q.all(c)},a.prototype.$copyMessages=function(b,c){var d=[];return _.forEach(b,function(a,b){if(a.length>0){var e=a[0].$mailbox,f=e.$copyMessages(a,c);d.push(f)}}),a.$q.all(d)},a.prototype.$moveMessages=function(b,c){var d=[];return _.forEach(b,function(a,b){if(a.length>0){var e=a[0].$mailbox,f=e.$moveMessages(a,c);d.push(f)}}),a.$q.all(d)}}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i,j,k,m,n,o,p,q,r,s){function t(a){a.push(k.createHotkey({key:l("hotkey_search"),description:l("Search"),callback:C.searchMode})),a.push(k.createHotkey({key:l("hotkey_compose"),description:l("Write a new message"),callback:function(a){null===C.messageDialog&&C.newMessage(a)}})),a.push(k.createHotkey({key:l("hotkey_junk"),description:l("Mark the selected messages as junk"),callback:C.markOrUnMarkMessagesAsJunk})),a.push(k.createHotkey({key:"space",description:l("Toggle item"),callback:C.toggleMessageSelection})),a.push(k.createHotkey({key:"shift+space",description:l("Toggle range of items"),callback:C.toggleMessageSelection})),a.push(k.createHotkey({key:"up",description:l("View next item"),callback:w,preventInClass:["sg-mail-part"]})),a.push(k.createHotkey({key:"down",description:l("View previous item"),callback:x,preventInClass:["sg-mail-part"]})),a.push(k.createHotkey({key:"shift+up",description:l("Add next item to selection"),callback:y,preventInClass:["sg-mail-part"]})),a.push(k.createHotkey({key:"shift+down",description:l("Add previous item to selection"),callback:z,preventInClass:["sg-mail-part"]})),_.forEach(["backspace","delete"],function(b){a.push(k.createHotkey({key:b,description:l("Delete selected message or folder"),callback:C.confirmDeleteSelectedMessages}))}),_.forEach(a,function(a){k.registerHotkey(a)})}function u(a){return C.selectedFolder.$compact()}function v(){var b=[n.baseURL(),"UIxMailPopupView#!/Mail",C.account.id,m(m(C.selectedFolder.path)),"new"].join("/"),c=C.selectedFolder.$id()+"/"+Math.random(0,1e3);console.debug(b),a.open(b,c,["width=680","height=520","resizable=1","scrollbars=1","toolbar=0","location=0","directories=0","status=0","menubar=0","copyhistory=0"].join(","))}function w(a){var b=C.selectedFolder.$selectedMessageIndex();return angular.isDefined(b)?(b--,C.selectedFolder.$topIndex>0&&C.selectedFolder.$topIndex--):(b=C.selectedFolder.getLength()-1,C.selectedFolder.$topIndex=C.selectedFolder.getLength()),b>-1&&C.selectMessage(C.selectedFolder.$messages[b]),a.preventDefault(),b}function x(a){var b=C.selectedFolder.$selectedMessageIndex();return angular.isDefined(b)?(b++,C.selectedFolder.$topIndex<C.selectedFolder.getLength()&&C.selectedFolder.$topIndex++):b=0,b<C.selectedFolder.getLength()?C.selectMessage(C.selectedFolder.$messages[b]):b=-1,a.preventDefault(),b}function y(a){var b;C.selectedFolder.hasSelectedMessage()&&(b=w(a),b>=0&&C.toggleMessageSelection(a,C.selectedFolder.$messages[b]))}function z(a){var b;C.selectedFolder.hasSelectedMessage()&&(b=x(a),b>=0&&C.toggleMessageSelection(a,C.selectedFolder.$messages[b]))}function A(){return s.$virtualMode?C.selectedFolder.$mailboxes:[C.selectedFolder]}function B(a,b){var d,f,g=b;C.mode.multiple=C.selectedFolder.$selectedCount(),a?(b>0&&(g-=1,d=C.selectedFolder.$messages[g]),b<C.selectedFolder.$messages.length&&(f=C.selectedFolder.$messages[b]),d?d.isread&&f&&!f.isread&&(g=b,d=f):f&&(g=b,d=f),d?(C.selectedFolder.$topIndex=g,e.go("mail.account.mailbox.message",{messageId:d.uid})):e.go("mail.account.mailbox")):c(function(){console.warn("go to mailbox"),e.go("mail.account.mailbox")})}var C=this,D=angular.element(a.document).find("title").attr("sg-default")||"SOGo",E=[];this.$onInit=function(){a.$mailboxController=C,this.service=s,this.accounts=h,this.account=i,this.selectedFolder=j,this.messageDialog=null,this.mode={search:!1,multiple:0},t(E),angular.element(a).on("beforeunload",u),b.$on("$destroy",function(){angular.element(a).off("beforeunload",u),_.forEach(E,function(a){k.deregisterHotkey(a)})}),b.$watch(function(){return C.selectedFolder.unseenCount},function(b){var c=D+" - ";b&&(c+="("+b+") "),c+=C.selectedFolder.$displayName,a.document.title=c})},this.centerIsClose=function(a){return this.selectedFolder.hasSelectedMessage()&&!!a},this.sort=function(a){C.selectedFolder.$filter({sort:a})},this.sortedBy=function(a){return s.$query.sort==a},this.searchMode=function(){C.mode.search=!0,o("search")},this.cancelSearch=function(){C.mode.search=!1,C.selectedFolder.$filter().then(function(){C.selectedFolder.selectedMessage&&c(function(){C.selectedFolder.$topIndex=C.selectedFolder.uidsMap[C.selectedFolder.selectedMessage]})})},this.composeWindowEnabled=function(){return q.defaults.SOGoMailComposeWindowEnabled},this.newMessage=function(a,b){var c;null===C.messageDialog&&(b||"popup"==q.defaults.SOGoMailComposeWindow?v():(c=C.account.$newMessage(),C.messageDialog=f.show({parent:angular.element(document.body),targetEvent:a,clickOutsideToClose:!1,escapeToClose:!1,templateUrl:"UIxMailEditor",controller:"MessageEditorController",controllerAs:"editor",locals:{stateAccount:C.account,stateMessage:c}}).catch(_.noop).finally(function(){C.messageDialog=null})))},this.selectMessage=function(a){s.$virtualMode?e.go("mail.account.virtualMailbox.message",{mailboxId:m(a.$mailbox.path),messageId:a.uid}):e.go("mail.account.mailbox.message",{messageId:a.uid})},this.toggleMessageSelection=function(a,b){var c,d,e,f=C.selectedFolder;if(b||(b=f.$selectedMessage()),!b)return!0;if(b.selected=!b.selected,C.mode.multiple+=b.selected?1:-1,a.shiftKey&&f.$selectedCount()>1){for(c=f.uidsMap[b.uid],d=c-2;d>=0&&!f.$messages[d].selected;)d--;if(d<0)for(d=c+2;d<f.getLength()&&!f.$messages[d].selected;)d++;if(d>=0&&d<f.getLength())for(e=Math.min(c,d);e<=Math.max(c,d);e++)f.$messages[e].selected=!0}a.preventDefault(),a.stopPropagation()},this.confirmDeleteSelectedMessages=function(a){var b=C.selectedFolder.$selectedMessages();null===C.messageDialog&&_.size(b)>0&&(C.messageDialog=p.confirm(l("Confirmation"),l("Are you sure you want to delete the selected messages?"),{ok:l("Delete")}).then(function(){var a=C.selectedFolder.hasSelectedMessage();C.selectedFolder.$deleteMessages(b).then(function(b){s.$virtualMode?a&&e.go("mail.account.virtualMailbox"):B(a,b)},function(c){C.messageDialog=p.confirm(l("Warning"),l("The messages could not be moved to the trash folder. Would you like to delete them immediately?"),{ok:l("Delete")}).then(function(){C.selectedFolder.$deleteMessages(b,{withoutTrash:!0}).then(function(b){s.$virtualMode?a&&e.go("mail.account.virtualMailbox"):B(a,b)})})})}).finally(function(){C.messageDialog=null})),a.preventDefault()},this.markOrUnMarkMessagesAsJunk=function(){var a=C.selectedFolder.hasSelectedMessage(),b=C.selectedFolder.$selectedMessages();0===_.size(b)&&a&&(b=[C.selectedFolder.$selectedMessage()]),_.size(b)>0&&C.selectedFolder.$markOrUnMarkMessagesAsJunk(b).then(function(){var c="/"+C.account.id+"/folderINBOX";"junk"!=C.selectedFolder.type&&(c="/"+C.account.$getMailboxByType("junk").id),C.selectedFolder.$moveMessages(b,c).then(function(b){s.$virtualMode?a&&e.go("mail.account.virtualMailbox"):B(a,b)})})},this.copySelectedMessages=function(a){var b=C.selectedFolder.$selectedMessages();_.size(b)>0&&C.selectedFolder.$copyMessages(b,"/"+a).then(function(){g.show(g.simple().content(l("%{0} message(s) copied",C.selectedFolder.$selectedCount())).position("top right").hideDelay(2e3))})},this.moveSelectedMessages=function(a){var b=C.selectedFolder.hasSelectedMessage(),c=C.selectedFolder.$selectedMessages(),d=C.selectedFolder.$selectedCount();_.size(c)>0&&C.selectedFolder.$moveMessages(c,"/"+a).then(function(a){g.show(g.simple().content(l("%{0} message(s) moved",d)).position("top right").hideDelay(2e3)),s.$virtualMode?b&&e.go("mail.account.virtualMailbox"):B(b,a)})},this.selectAll=function(){var a=0;_.forEach(A(),function(b){for(var c=0,d=b.$messages.length;c<d;c++)b.$messages[c].selected=!0;a+=d}),C.mode.multiple=a},this.unselectMessages=function(){_.forEach(A(),function(a){_.forEach(a.$messages,function(a){a.selected=!1})}),C.mode.multiple=0},this.markSelectedMessagesAsFlagged=function(){var a=C.selectedFolder.$selectedMessages();_.size(a)>0&&C.selectedFolder.$flagMessages(a,"\\Flagged","add").then(function(a){_.forEach(a,function(a){a.isflagged=!0})})},this.markSelectedMessagesAsUnread=function(){var a=C.selectedFolder.$selectedMessages();_.size(a)>0&&C.selectedFolder.$flagMessages(a,"seen","remove").then(function(a){_.forEach(a,function(a){a.isread&&a.$mailbox.unseenCount++,a.isread=!1})})},this.markSelectedMessagesAsRead=function(){var a=C.selectedFolder.$selectedMessages();_.size(a)>0&&C.selectedFolder.$flagMessages(a,"seen","add").then(function(a){_.forEach(a,function(a){a.isread||a.$mailbox.unseenCount--,a.isread=!0})})}}function b(a){return a[0].controller.prototype.resetScroll=function(){"messagesList"==this.$element.parent().attr("id")?this.updateSize():this.scrollTo(0)},a}a.$inject=["$window","$scope","$timeout","$q","$state","$mdDialog","$mdToast","stateAccounts","stateAccount","stateMailbox","sgHotkeys","encodeUriFilter","sgSettings","sgFocus","Dialog","Preferences","Account","Mailbox"],angular.module("SOGo.MailerUI").controller("MailboxController",a),b.$inject=["$delegate"],angular.module("material.components.virtualRepeat").decorator("mdVirtualRepeatContainerDirective",b)}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i,j,k,m,n,o,p,q,r,s){function t(a){_.forEach(["backspace","delete"],function(b){a.push(m.createHotkey({key:b,description:l("Delete selected message or folder"),callback:function(){o.selectedFolderController&&o.selectedFolder&&!o.selectedFolder.hasSelectedMessage()&&o.selectedFolderController.confirmDelete(o.selectedFolder)}}))}),_.forEach(a,function(a){m.registerHotkey(a)})}var u,v,w=this,x=[];this.$onInit=function(){this.service=o,this.accounts=s,this.currentSearchParam="",this.search={options:{"":"",subject:l("Enter Subject"),from:l("Enter From"),to:l("Enter To"),cc:l("Enter Cc"),body:l("Enter Body")},subfolders:1,match:"AND",params:[]},this.showSubscribedOnly=r.defaults.SOGoMailShowSubscribedFoldersOnly,this.refreshUnseenCount(),t(x),a.$on("$destroy",function(){_.forEach(x,function(a){m.deregisterHotkey(a)})})},this.hideAdvancedSearch=function(){w.service.$virtualPath=!1,w.service.$virtualMode=!1,u=w.accounts[0],v=w.searchPreviousMailbox,b.go("mail.account.mailbox",{accountId:u.id,mailboxId:i(v.path)})},this.toggleAdvancedSearch=function(){if(o.selectedFolder.$isLoading)w.virtualMailbox.stopSearch();else{var a,c=[],d=function(a){_.forEach(a,function(a){c.push(a),a.children&&a.children.length>0&&d(a.children)})};w.virtualMailbox=new p(w.accounts[0]),o.$virtualMode||(w.searchPreviousMailbox=o.selectedFolder),o.selectedFolder=w.virtualMailbox,o.$virtualMode=!0,angular.isDefined(o.$virtualPath)?(a=w.accounts[0].$getMailboxByPath(o.$virtualPath),c.push(a),w.search.subfolders&&a.children.length&&d(a.children)):c=w.accounts[0].$flattenMailboxes(),w.virtualMailbox.setMailboxes(c),w.virtualMailbox.startSearch(w.search.match,w.search.params),"mail.account.virtualMailbox"!=b.$current.name&&b.go("mail.account.virtualMailbox",{accountId:w.accounts[0].id})}},this.addSearchParam=function(a){return w.currentSearchParam=a,h("advancedSearch"),!1},this.newSearchParam=function(a){if(a.length&&w.currentSearchParam.length){var b=0,c=w.currentSearchParam;return a.startsWith("!")&&(b=1,a=a.substring(1).trim()),w.currentSearchParam="",{searchBy:c,searchInput:a,negative:b}}},this.toggleAccountState=function(a){a.$expanded=!a.$expanded,a.$flattenMailboxes({reload:!0,saveState:!0}),d(function(){angular.element(e).triggerHandler("resize")},150)},this.subscribe=function(a){function b(a,b,c){function d(){b.hide()}var e=this;e.loading=!0,e.filter={name:""},e.account=new n({id:c.id,name:c.name}),e.close=d,e.account.$getMailboxes({reload:!0,all:!0}).then(function(){e.loading=!1})}f.show({templateUrl:a.id+"/subscribe",controller:b,controllerAs:"subscriptions",clickOutsideToClose:!0,escapeToClose:!0,locals:{srcAccount:a}}).finally(function(){a.$getMailboxes({reload:!0})}),b.$inject=["$scope","$mdDialog","srcAccount"]},this.newFolder=function(a){j.prompt(l("New Folder..."),l("Enter the new name of your folder")).then(function(b){a.$newMailbox(a.id,b).then(function(){},function(a,c){j.alert(l('An error occured while creating the mailbox "%{0}".',b),l(a.error))})})},this.delegate=function(a){function b(a,b,c,d){function e(a){return c.$filter(a,d.delegates)}function f(){b.hide()}function g(a){d.$removeDelegate(a.uid).catch(function(a,b){j.alert(l("Warning"),l("An error occured please try again."))})}function h(a){a&&d.$addDelegate(a).then(function(){i.userToAdd="",i.searchText=""},function(a){j.alert(l("Warning"),a)})}var i=this;i.users=d.delegates,i.account=d,i.userToAdd="",i.searchText="",i.userFilter=e,i.closeModal=f,i.removeUser=g,i.addUser=h}f.show({templateUrl:a.id+"/delegation",controller:b,controllerAs:"delegate",clickOutsideToClose:!0,escapeToClose:!0,locals:{User:q,account:a}}),b.$inject=["$scope","$mdDialog","User","account"]},this.refreshUnseenCount=function(){var a,b=e.unseenCountFolders;_.forEach(w.accounts,function(a){_.includes(b,a.id+"/folderINBOX")||b.push(a.id+"/folderINBOX"),_.forEach(a.$$flattenMailboxes,function(a){angular.isDefined(a.unseenCount)&&!_.includes(b,a.id)&&b.push(a.id)})}),n.$$resource.post("","unseenCount",{mailboxes:b}).then(function(a){_.forEach(w.accounts,function(b){_.forEach(b.$$flattenMailboxes,function(b){a[b.id]&&(b.unseenCount=a[b.id])})})}),a=r.defaults.SOGoRefreshViewCheck,a&&"manually"!=a&&d(w.refreshUnseenCount,1e3*a.timeInterval())},this.isDroppableFolder=function(a,b){return b.id!=a.id&&!b.isNoSelect()},this.dragSelectedMessages=function(a,c,d){var e,f,h,i,j,k;e="/"+c.id,f=a.$selectedMessages(),0===f.length&&(f=[a.$selectedMessage()]),h=_.map(f,"uid"),i=a.selectedMessage&&h.indexOf(a.selectedMessage)>=0,"copy"==d?(j=a.$copyMessages(f,e),k=l("%{0} message(s) copied",f.length)):(j=a.$moveMessages(f,e),k=l("%{0} message(s) moved",f.length)),j.then(function(){i&&b.go("mail.account.mailbox"),g.show(g.simple().content(k).position("top right").hideDelay(2e3))})}}a.$inject=["$scope","$state","$transitions","$timeout","$window","$mdDialog","$mdToast","sgFocus","encodeUriFilter","Dialog","sgSettings","sgHotkeys","Account","Mailbox","VirtualMailbox","User","Preferences","stateAccounts"],angular.module("SOGo.MailerUI").controller("MailboxesController",a)}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i,j,k,m,n,o,p,q,r,s,t,u,v,w){function x(){return b.mailbox?(arguments.length>0&&(b.mailbox.messageDialog=arguments[0]),b.mailbox.messageDialog):null}function y(a){return function(){if(null===x())return a.apply(D,arguments)}}function z(a){a.push(k.createHotkey({key:l("hotkey_reply"),description:l("Reply to the message"),callback:y(angular.bind(D,D.reply))})),a.push(k.createHotkey({key:l("hotkey_replyall"),description:l("Reply to sender and all recipients"),callback:y(angular.bind(D,D.replyAll))})),a.push(k.createHotkey({key:l("hotkey_forward"),description:l("Forward selected message"),callback:y(angular.bind(D,D.forward))})),a.push(k.createHotkey({key:l("hotkey_flag"),description:l("Flagged"),callback:y(angular.bind(j,j.toggleFlag))})),_.forEach(["backspace","delete"],function(b){a.push(k.createHotkey({key:b,callback:y(function(a){0===D.mailbox.$selectedCount()&&D.deleteMessage(),a.preventDefault()})}))}),_.forEach(a,function(a){k.registerHotkey(a)})}function A(){var b,c,d={};return a.opener&&a.opener.$mailboxController&&a.opener.$mailboxController.selectedFolder.$id()==i.$id()&&(c=a.opener.$mailboxController,d.mailboxCtrl=c,a.opener.$messageController&&a.opener.$messageController.message.uid==j.uid&&(b=a.opener.$messageController,d.messageCtrl=b)),d}function B(a,b){null===x()&&x(e.show({parent:angular.element(document.body),targetEvent:a,clickOutsideToClose:!1,escapeToClose:!1,templateUrl:"UIxMailEditor",controller:"MessageEditorController",controllerAs:"editor",locals:{stateAccount:D.account,stateMessage:b}}).catch(_.noop).finally(function(){x(null),D.closePopup()}))}function C(a,b){D.message.$plainContent().then(function(c){var d={pid:s.$defaultCalendar(),type:b,summary:c.subject,comment:c.content},f=new t(d),g=[n.activeUser("folderURL"),"Calendar","UIx"+b.capitalize()+"EditorTemplate"].join("/");return e.show({parent:angular.element(document.body),targetEvent:a,clickOutsideToClose:!0,escapeToClose:!0,templateUrl:g,controller:"ComponentEditorController",controllerAs:"editor",locals:{stateComponent:f}})})}var D=this,E=null,F=[];this.$onInit=function(){a.$messageController=D,o.setMessage(j),this.$state=c,this.accounts=g,this.account=h,this.mailbox=i,this.message=j,this.service=w,this.tags={searchText:"",selected:""},this.showFlags=j.flags&&j.flags.length>0,this.$showDetailedRecipients=!1,D.showRawSource=!1,z(F),a.opener?(b.$watchCollection(function(){return D.message.flags},function(a,b){var c;(a||b)&&(c=A(),c.messageCtrl&&c.messageCtrl.service.$timeout(function(){c.messageCtrl.showFlags=!0,c.messageCtrl.message.flags=a}))}),b.$watch(function(){return D.message.isflagged},function(a,b){var c=A();c.mailboxCtrl&&c.mailboxCtrl.service.$timeout(function(){var b=_.find(c.mailboxCtrl.selectedFolder.$messages,{uid:D.message.uid});b.isflagged=a})})):b.$watchCollection(function(){return D.message.flags},function(a,b){var c,d,e;(a||b)&&(c=a||[],d=b||[],_.forEach(c,function(a,b){angular.isObject(a)&&(c[b]=a.name)}),c.length>d.length?(e=_.difference(c,d),_.forEach(e,function(a){D.message.addTag(a)})):c.length<d.length&&(e=_.difference(d,c),_.forEach(e,function(a){D.message.removeTag(a)})))}),b.$on("$destroy",function(){_.forEach(F,function(a){k.deregisterHotkey(a)})})},this.addFlags=function(a){this.showFlags=!0,p("flags")},this.toggleDetailedRecipients=function(a){this.$showDetailedRecipients=!this.$showDetailedRecipients,a.stopPropagation(),a.preventDefault()},this.filterMailtoLinks=function(a){var b,c;"A"==a.target.tagName&&"href"in a.target.attributes&&(b=a.target.attributes.href.value,c=/^mailto:([^\?]+)/.exec(b),c&&(delete a.target.attributes.target,this.newMessage(a,b)))},this.deleteMessage=function(){var a,b,e,g,h,k=A();k.messageCtrl?(a=k.mailboxCtrl.selectedFolder,b=k.messageCtrl.message,e=k.messageCtrl.$state):(a=i,b=j,e=c),a.$deleteMessages([b]).then(function(c){var i=c;if(b=null,angular.isDefined(e)){c>0&&(i-=1,g=a.$messages[i]),c<a.$messages.length&&(h=a.$messages[c]),g?g.isread&&h&&!h.isread&&(i=c,g=h):h&&(i=c,g=h);try{g&&d(f["gt-md"])?(e.go("mail.account.mailbox.message",{messageId:g.uid}),i<a.$topIndex?a.$topIndex=i:i>a.$lastVisibleIndex&&(a.$topIndex=i-(a.$lastVisibleIndex-a.$topIndex))):e.go("mail.account.mailbox").then(function(){b=null,delete a.selectedMessage})}catch(a){}}D.closePopup()})},this._showMailEditorInPopup=function(a){return!n.isPopup&&"popup"==r.defaults.SOGoMailComposeWindow&&(this.openInPopup(a),!0)},this.close=function(){c.go("mail.account.mailbox").then(function(){D.message=null,delete i.selectedMessage})},this.reply=function(a){this._showMailEditorInPopup("reply")||B(a,this.message.$reply())},this.replyAll=function(a){this._showMailEditorInPopup("replyall")||B(a,this.message.$replyAll())},this.forward=function(a){this._showMailEditorInPopup("forward")||B(a,this.message.$forward())},this.edit=function(a){this._showMailEditorInPopup("edit")||this.message.$editableContent().then(function(){B(a,D.message)})},this.openInPopup=function(b){var c=[n.baseURL(),"UIxMailPopupView#!/Mail",this.message.accountId,m(m(this.message.$mailbox.path)),this.message.uid].join("/"),d=this.message.$absolutePath();b&&(c+="/"+b),E=a.open(c,d,["width=680","height=520","resizable=1","scrollbars=1","toolbar=0","location=0","directories=0","status=0","menubar=0","copyhistory=0"].join(","))},this.closePopup=function(){a.document.body.classList.contains("popup")&&a.close()},this.newMessage=function(a,b){a.stopPropagation(),a.preventDefault(),this.account.$newMessage({mailto:b}).then(function(b){B(a,b)})},this.toggleRawSource=function(a){this.showRawSource||this.message.$rawSource?this.showRawSource=!this.showRawSource:w.$$resource.post(this.message.id,"viewsource").then(function(a){D.message.$rawSource=a,D.showRawSource=!0})},this.print=function(b){a.print()},this.convertToEvent=function(a){return C(a,"appointment")},this.convertToTask=function(a){return C(a,"task")}}a.$inject=["$window","$scope","$state","$mdMedia","$mdDialog","sgConstant","stateAccounts","stateAccount","stateMailbox","stateMessage","sgHotkeys","encodeUriFilter","sgSettings","ImageGallery","sgFocus","Dialog","Preferences","Calendar","Component","Account","Mailbox","Message"],angular.module("SOGo.MailerUI").controller("MessageController",a)}(),function(){"use strict";function a(a,b,c,d,e,f,g,h,i,j,k,m,n,o,p,q){function r(){var a,c={};try{b.opener&&"$mailboxController"in b.opener&&"selectedFolder"in b.opener.$mailboxController&&("draft"==b.opener.$mailboxController.selectedFolder.type?(c.draftMailboxCtrl=b.opener.$mailboxController,"$messageController"in b.opener&&b.opener.$messageController.message.uid==j.uid&&(c.draftMessageCtrl=b.opener.$messageController)):j.origin&&(a=j.origin.message,b.opener.$mailboxController.selectedFolder.$id()==a.$mailbox.$id()&&(c.originMailboxCtrl=b.opener.$mailboxController)))}catch(a){}return c}function s(){D.uploader=new h({url:D.message.$absolutePath({asDraft:!0,withResourcePath:!0})+"/save",autoUpload:!0,alias:"attachments",removeAfterUpload:!1,onSuccessItem:function(a,b,c,d){D.message.$setUID(b.uid),D.message.$reload({asDraft:!1}),a.inlineUrl=b.lastAttachmentAttrs[0].url},onCancelItem:function(a,b,c,d){D.message.$deleteAttachment(a.file.name),this.removeFromQueue(a)},onErrorItem:function(a,b,c,d){g.show(g.simple().content(l('Error while uploading the file "%{0}":',a.file.name)+" "+(b.message?l(b.message):"")).position("top right").action(l("OK")).hideDelay(!1)),this.removeFromQueue(a)}})}function t(){D.uploader.url=D.message.$absolutePath({asDraft:!0,withResourcePath:!0})+"/save"}function u(){var a,b,c,d=D.message.editable.attachmentAttrs;if(d)for(a=0;a<d.length;a++)b={name:d[a].filename,type:d[a].mimetype,size:parseInt(d[a].size)},c=new h.FileItem(D.uploader,b),c.progress=100,c.isUploaded=!0,c.isSuccess=!0,c.inlineUrl=d[a].url,D.uploader.queue.push(c)}function v(a,c){a.isUploading?D.uploader.cancelItem(a):(D.message.$deleteAttachment(a.file.name),a.remove());var d=b.document.getElementById(c);d&&angular.element(d).prop("value",null)}function w(){D.autosave&&m.cancel(D.autosave),D.message.isNew&&D.message.attachmentAttrs&&D.message.$mailbox.$deleteMessages([D.message]),f.cancel()}function x(){var a=r();D.message.$save().then(function(b){D.message.$rawSource=null,a.draftMailboxCtrl&&a.draftMailboxCtrl.selectedFolder.$filter().then(function(){a.draftMessageCtrl&&a.draftMessageCtrl.$state.go("mail.account.mailbox.message",{messageId:D.message.uid})}),g.show(g.simple().content(l("Your email has been saved")).position("top right").hideDelay(3e3))})}function y(){D.sendState="sending",D.autosave&&m.cancel(D.autosave),D.message.$send().then(function(a){var b=r();D.sendState="sent",b.draftMailboxCtrl&&b.draftMailboxCtrl.selectedFolder.$filter().then(function(){b.draftMessageCtrl&&b.draftMessageCtrl.close()}),b.originMailboxCtrl&&b.originMailboxCtrl.selectedFolder.$filter(),g.show(g.simple().content(l("Your email has been sent")).position("top right").hideDelay(3e3)),m(f.hide,1e3)},function(a){m(function(){D.sendState="error",D.errorMessage=a.data?a.data.message:a.statusText})})}function z(){D.isFullscreen=!D.isFullscreen}function A(a){return o.$filterAll(a).then(function(a){var b=[];return _.forEach(_.invokeMap(a,"explode"),function(a){_.forEach(a,function(a){b.push(a)})}),_.uniqBy(b,function(a){return a.$$fullname+" "+a.$$email})})}function B(a,b){var c,d,e,f,g,h=/([\w\!\#$\%\&\'\*\+\-\/\=\?\^\`{\|\}\~]+\.)*[\w\!\#$\%\&\'\*\+\-\/\=\?\^\`{\|\}\~]+@((((([a-z0-9]{1}[a-z0-9\-]{0,62}[a-z0-9]{1})|[a-z])\.)+[a-z]{2,})|(\d{1,3}\.){3}\d{1,3}(\:\d{1,5})?)/i;if(c=D.message.editable[b],angular.isString(a)){for(g="",f=0;f<a.length;f++)9!=a.charCodeAt(f)&&32!=a.charCodeAt(f)&&44!=a.charCodeAt(f)&&59!=a.charCodeAt(f)||!h.test(g)?g+=a.charAt(f):(c.push(g),g="");return g&&c.push(g),null}return a.$isList({expandable:!0})?angular.isDefined(a.refs)&&a.refs.length?_.forEach(a.refs,function(a){a.email.length&&c.push(a.$shortFormat())}):(e=p.$find(a.container,a.c_name),e.$id().then(function(a){_.forEach(e.refs,function(a){a.email.length&&c.push(a.$shortFormat())})})):d=a.$shortFormat(),d?d:null}function C(){D.message.$save(),q.defaults.SOGoMailAutoSave&&(D.autosave=m(D.autosaveDrafts,1e3*q.defaults.SOGoMailAutoSave*60))}var D=this;this.$onInit=function(){D.addRecipient=B,D.autocomplete={to:{},cc:{},bcc:{}},D.autosave=null,D.autosaveDrafts=C,D.cancel=w,D.contactFilter=A,D.isFullscreen=!1,D.hideBcc=0===j.editable.bcc.length,D.hideCc=0===j.editable.cc.length,D.identities=_.uniq(_.map(i.identities,"full")),D.message=j,D.recipientSeparatorKeys=[d.KEY_CODE.ENTER,d.KEY_CODE.TAB,d.KEY_CODE.COMMA,d.KEY_CODE.SEMICOLON],D.removeAttachment=v,D.save=x,D.send=y,D.sendState=!1,D.toggleFullscreen=z,s(),q.defaults.SOGoMailAutoSave&&(D.autosave=m(D.autosaveDrafts,1e3*q.defaults.SOGoMailAutoSave*60)),D.localeCode=q.defaults.LocaleCode,a.$on("$destroy",function(){D.uploader.destroy()}),"reply"==c.actionName?j.$reply().then(function(a){D.message=a,D.hideCc=!a.editable.cc||0===a.editable.cc.length,D.hideBcc=!a.editable.bcc||0===a.editable.bcc.length,t()}):"replyall"==c.actionName?j.$replyAll().then(function(a){D.message=a,D.hideCc=!a.editable.cc||0===a.editable.cc.length,D.hideBcc=!a.editable.bcc||0===a.editable.bcc.length,t()}):"forward"==c.actionName?j.$forward().then(function(a){D.message=a,t(),u()}):angular.isDefined(j)&&(D.message=j,t(),u())}}function b(a,b){a.closeToast=function(){b.hide()}}a.$inject=["$scope","$window","$stateParams","$mdConstant","$mdUtil","$mdDialog","$mdToast","FileUploader","stateAccount","stateMessage","encodeUriFilter","$timeout","Dialog","AddressBook","Card","Preferences"],b.$inject=["$scope","$mdToast"],angular.module("SOGo.MailerUI").controller("SendMessageToastController",b).controller("MessageEditorController",a)}(),function(){function a(){return{restrict:"C",scope:{},controller:"sgAccountController"}}function b(a,b,c,d,e,f,g,h){var i=[];this.$postLink=function(){this.quotaElement=_.find(a.find("div"),function(a){return a.classList.contains("sg-quota")})},this.addMailboxController=function(a){i.push(a)},this.selectFolder=function(a){if(g.selectedFolderController=a,null!==g.selectedFolder){var b=_.find(i,function(a){return a.mailbox.id==g.selectedFolder.id});b&&b.unselectFolder()}d(f["gt-md"])||e("left").close()}}b.$inject=["$element","$transitions","$state","$mdMedia","$mdSidenav","sgConstant","Mailbox","encodeUriFilter"],angular.module("SOGo.MailerUI").controller("sgAccountController",b).directive("sgAccountSection",a)}(),function(){function a(a,b,c,d,e,f,g,h,i,j,k){this.$onInit=function(){},this.$postLink=function(){},this.addImage=function(a){console.warn(a)},this.showGallery=function(a,b){function c(a,b,c){}var d=e.newPanelPosition().relativeTo(a.target).addPanelPosition(e.xPosition.ALIGN_START,e.yPosition.ALIGN_TOPS),f=e.newPanelAnimation().openFrom(a.target).duration(100).withAnimation(e.animation.FADE),g={attachTo:angular.element(document.body),locals:{message:this.message},bindToController:!0,controller:c,controllerAs:"$panelCtrl",position:d,animation:f,targetEvent:a,fullscreen:!0,template:['<div class="sg-image-gallery" layout="column" layout-fill="layout-fill">','  <div layout="row">',"    <></>","foobar","</div>"].join(""),trapFocus:!0,clickOutsideToClose:!0,escapeToClose:!0,focusOnOpen:!0};e.open(g).then(function(a){a.panelEl.one("click",function(){a.close()})}),c.$inject=["mdPanelRef","$state","$mdDialog"]}}a.$inject=["$scope","$element","$state","$mdToast","$mdPanel","$mdMedia","$mdSidenav","sgConstant","Dialog","Mailbox","encodeUriFilter"]}(),function(){"use strict";function a(){function a(a,b,c,d){d.pathToAttachment=c.sgImipPath}return{restrict:"A",link:a,controller:"sgImipController"}}function b(a,b){var c=this;a.delegateInvitation=!1,a.delegatedTo="",a.searchText="",a.userFilter=function(a){return b.$filter(a)},a.iCalendarAction=function(b){var d;"delegate"==b&&(d={receiveUpdates:!1,delegatedTo:a.delegatedTo.c_email}),a.viewer.message.$imipAction(c.pathToAttachment,b,d)}}b.$inject=["$scope","User"],angular.module("SOGo.MailerUI").controller("sgImipController",b).directive("sgImip",a)}(),function(){function a(){return{restrict:"C",require:{accountController:"^^sgAccountSection"},scope:{},bindToController:{mailbox:"=sgMailbox"},template:['  <div class="sg-child-level-0"','       ng-class="$ctrl.childLevel()">','    <md-checkbox class="sg-folder"','                 ng-class="$ctrl.mailbox.$icon"','                 aria-label="'+l("Expanded")+'"','                 ng-model="$ctrl.mailbox.$expanded"','                 ng-disabled="$ctrl.mailbox.children.length == 0"','                 ng-change="$ctrl.mailbox.$account.$flattenMailboxes({ reload: true, saveState: true })">',"    <md-icon>{{$ctrl.mailbox.$icon}}</md-icon></md-checkbox>","  </div>",'  <p class="sg-item-name"','    ng-click="$ctrl.selectFolder($event)"','    ng-dblclick="$ctrl.editFolder($event)">','    <span ng-bind="$ctrl.mailbox.$displayName"></span>','    <span class="sg-counter-badge ng-hide"','          ng-show="$ctrl.mailbox.unseenCount"','          ng-bind="$ctrl.mailbox.unseenCount"></span>',"  </p>",'  <md-input-container class="md-flex ng-hide">','    <input class="sg-item-name" type="text"','           aria-label="'+l("Enter the new name of your folder")+'"','           ng-blur="$ctrl.saveFolder($event)"','           sg-enter="$ctrl.saveFolder($event)"','           sg-escape="$ctrl.revertEditing()" />',"  </md-input-container>",'  <md-icon class="md-menu" ng-click="$ctrl.showMenu($event)" aria-label="'+l("Options")+'">more_vert</md-icon>'].join(""),controller:"sgMailboxListItemController",controllerAs:"$ctrl"}}function b(a,b,c,d,e,f,g,h,i,j,k){var m=this;this.$onInit=function(){this.$element=b,this.editMode=!1,this.accountController.addMailboxController(this)},this.$postLink=function(){this.selectableElement=b.find("div")[0],this.clickableElement=b.find("p")[0],this.inputContainer=b.find("md-input-container")[0],
this.inputElement=b.find("input")[0],this.moreOptionsButton=_.last(b.find("md-icon")),null!==j.selectedFolder&&j.selectedFolder.id==this.mailbox.id&&this.accountController.selectFolder(this)},this.childLevel=function(){return"sg-child-level-"+this.mailbox.level},this.selectFolder=function(a){this.editMode||this.mailbox==j.selectedFolder||this.mailbox.isNoSelect()||(j.$virtualPath=!1,j.$virtualMode=!1,this.accountController.selectFolder(this),a&&(c.go("mail.account.mailbox",{accountId:this.mailbox.$account.id,mailboxId:k(this.mailbox.path)}),a.stopPropagation(),a.preventDefault()))},this.unselectFolder=function(){b[0].classList.remove("md-bg")},this.editFolder=function(a){this.editMode=!0,this.inputElement.value=this.mailbox.name,this.clickableElement.classList.add("ng-hide"),this.inputContainer.classList.remove("ng-hide"),this.inputElement.focus(),this.inputElement.select(),a&&(a.stopPropagation(),a.preventDefault())},this.saveFolder=function(a){this.inputElement.disabled||(this.mailbox.name=this.inputElement.value,this.inputElement.disabled=!0,this.mailbox.$rename().then(function(a){m.editMode=!1,m.inputContainer.classList.add("ng-hide"),m.clickableElement.classList.remove("ng-hide")}).finally(function(){m.inputElement.disabled=!1}))},this.revertEditing=function(){this.editMode=!1,this.clickableElement.classList.remove("ng-hide"),this.inputContainer.classList.add("ng-hide"),this.inputElement.value=this.mailbox.name},this.confirmDelete=function(){i.confirm(l("Warning"),l("Do you really want to move this folder into the trash ?"),{ok:l("Delete")}).then(function(){m.mailbox.$delete().then(function(){c.go("mail.account.inbox")},function(a){i.confirm(l("Warning"),l("The mailbox could not be moved to the trash folder. Would you like to delete it immediately?"),{ok:l("Delete")}).then(function(){m.mailbox.$delete({withoutTrash:!0}).then(function(){c.go("mail.account.inbox")},function(a){i.alert(l('An error occured while deleting the mailbox "%{0}".',m.mailbox.name),l(a.error))})})})})},this.showMenu=function(a){function b(a,b,c,e){var k=this;this.markFolderRead=function(){this.folder.$markAsRead()},this.newFolder=function(){i.prompt(l("New Folder..."),l("Enter the new name of your folder")).then(function(a){k.folder.$newMailbox(k.folder.id,a).then(function(){},function(b,c){i.alert(l('An error occured while creating the mailbox "%{0}".',a),l(b.error))})})},this.editFolder=function(){this.itemCtrl.editFolder()},this.compactFolder=function(){this.folder.$compact().then(function(){d.show(d.simple().content(l("Folder compacted")).position("top right").hideDelay(3e3))})},this.emptyTrashFolder=function(){this.folder.$emptyTrash().then(function(){d.show(d.simple().content(l("Trash emptied")).position("top right").hideDelay(3e3))})},this.showAdvancedSearch=function(){j.$virtualPath=this.folder.path,f(h["gt-md"])||g("left").close()},this.share=function(){this.folder.$acl.$users().then(function(){c.show({templateUrl:k.folder.id+"/UIxAclEditor",controller:"AclController",controllerAs:"acl",clickOutsideToClose:!0,escapeToClose:!0,locals:{usersWithACL:k.folder.$acl.users,User:e,folder:k.folder}})})},this.setFolderAs=function(a){this.folder.$setFolderAs(a).then(function(){k.folder.$account.$getMailboxes({reload:!0})})}}var c=e.newPanelPosition().relativeTo(this.moreOptionsButton).addPanelPosition(e.xPosition.ALIGN_START,e.yPosition.ALIGN_TOPS),k=e.newPanelAnimation().openFrom(this.moreOptionsButton).duration(100).withAnimation(e.animation.FADE),m={attachTo:angular.element(document.body),locals:{itemCtrl:this,folder:this.mailbox,confirmDelete:this.confirmDelete},bindToController:!0,controller:b,controllerAs:"$menuCtrl",position:c,animation:k,targetEvent:a,templateUrl:"UIxMailFolderMenu",trapFocus:!0,clickOutsideToClose:!0,escapeToClose:!0,focusOnOpen:!0};e.open(m).then(function(a){a.panelEl.one("click",function(){a.close()})}),b.$inject=["mdPanelRef","$state","$mdDialog","User"]}}b.$inject=["$scope","$element","$state","$mdToast","$mdPanel","$mdMedia","$mdSidenav","sgConstant","Dialog","Mailbox","encodeUriFilter"],angular.module("SOGo.MailerUI").controller("sgMailboxListItemController",b).directive("sgMailboxListItem",a)}(),function(){function a(){return{restrict:"C",scope:{},bindToController:{message:"=sgMessage"},controller:"sgMessageListItemController"}}function b(a,b,c){var d=this;this.$onInit=function(){var b=["uid","isread","isflagged","flags","subject"];this.MailboxService=c,"draft"==c.selectedFolder.type&&b.push("subject"),a.$watch(function(){return d.message?[_.pick(d.message,b)]:null},function(a,b){d.message&&d.onUpdate()},!0)},this.onUpdate=function(){this.message.isread?b.removeClass("unread"):b.addClass("unread"),c.selectedFolder.isSelectedMessage(this.message.uid,this.message.$mailbox.path)?b.addClass("md-default-theme md-accent md-bg md-hue-2"):b.removeClass("md-default-theme md-accent md-bg md-hue-2")},this.setVisibility=function(a,b){b?a.classList.remove("ng-hide"):a.classList.add("ng-hide")}}b.$inject=["$scope","$element","Mailbox"],angular.module("SOGo.MailerUI").controller("sgMessageListItemController",b).directive("sgMessageListItem",a)}(),function(){function a(){function a(a,b,c,d){a.parentController=d}return{restrict:"C",require:"^^sgMessageListItem",scope:{},template:['<div class="sg-tile-content">','  <div class="sg-md-subhead">',"    <div>",'      <span class="sg-label-outline ng-hide"><!-- mailbox --></span>','      <md-icon class="ng-hide">error</md-icon>',"      <span><!-- sender or recipient --></span>","    </div>",'    <div class="sg-tile-date"><!-- date --></div>',"  </div>",'  <div class="sg-md-body">','    <div class="sg-tile-subject"><!-- subject --></div>','    <div class="sg-tile-size"><!-- size --></div>',"  </div>","</div>",'<div class="sg-tile-icons">','  <md-icon class="ng-hide">star</md-icon>','  <md-icon class="ng-hide">reply</md-icon>','  <md-icon class="ng-hide">forward</md-icon>','  <md-icon class="ng-hide">attach_file</md-icon>',"</div>",'<div class="sg-progress-linear-bottom">','  <md-progress-linear class="md-accent"','                      md-mode="indeterminate"','                      ng-disabled="!$ctrl.message.$isLoading()"><!-- message loading progress --></md-progress-linear>',"</div>"].join(""),link:a,controller:"sgMessageListItemMainController",controllerAs:"$ctrl"}}function b(a,b,c,d,e,f,g,h,i){var j=this;this.$postLink=function(){var c,d,f,i;this.parentController=a.parentController,f=this.parentController.onUpdate,i=this.parentController.setVisibility,_.forEach(b.find("div"),function(a){a.classList.contains("sg-tile-content")?c=angular.element(a):a.classList.contains("sg-tile-icons")&&(d=angular.element(a))}),this.priorityIconElement=c.find("md-icon")[0],g.$virtualMode&&(this.mailboxNameElement=c.find("span")[0],this.mailboxNameElement.classList.remove("ng-hide")),this.senderElement=c.find("span")[1],_.forEach(c.find("div"),function(a){a.classList.contains("sg-tile-subject")?j.subjectElement=a:a.classList.contains("sg-tile-size")?j.sizeElement=a:a.classList.contains("sg-tile-date")&&(j.dateElement=a)}),_.forEach(d.find("md-icon"),function(a){"star"==a.textContent?j.flagIconElement=a:"reply"==a.textContent?j.answerIconElement=a:"forward"==a.textContent?j.forwardIconElement=a:"attach_file"==a.textContent&&(j.attachmentIconElement=a)}),this.parentController.onUpdate=function(){var a;j.message=j.parentController.message;var c=e.nodesToArray(b[0].querySelectorAll(".sg-category"));for(_.forEach(c,function(a){b[0].removeChild(a)}),a=0;a<j.message.flags.length&&a<5;a++){var d=j.message.flags[a];if(j.service.$tags[d]){var g=angular.element('<div class="sg-category"></div>');g.css("left",3*a+"px"),g.css("background-color",j.service.$tags[d][1]),b.prepend(g)}}j.mailboxNameElement&&(j.mailboxNameElement.innerHTML=j.message.$mailbox.$displayName),"sent"==j.MailboxService.selectedFolder.type?j.senderElement.innerHTML=j.message.$shortAddress("to").encodeEntities():j.senderElement.innerHTML=j.message.$shortAddress("from").encodeEntities(),j.message.priority&&j.message.priority.level<3?(j.priorityIconElement.classList.remove("ng-hide"),j.message.priority.level<2?j.priorityIconElement.classList.add("md-warn"):j.priorityIconElement.classList.remove("md-warn")):j.priorityIconElement.classList.add("ng-hide"),j.subjectElement.innerHTML=j.message.subject.encodeEntities(),j.sizeElement.innerHTML=j.message.size,j.dateElement.innerHTML=j.message.relativedate,i(j.flagIconElement,j.message.isflagged),i(j.answerIconElement,j.message.isanswered),i(j.forwardIconElement,j.message.isforwarded),i(j.attachmentIconElement,j.message.hasattachment),angular.bind(j.parentController,f)()},this.service=h,this.MailboxService=g}}b.$inject=["$scope","$element","$parse","$state","$mdUtil","$mdToast","Mailbox","Message","encodeUriFilter"],angular.module("SOGo.MailerUI").controller("sgMessageListItemMainController",b).directive("sgMessageListItemMain",a)}(),function(){"use strict";function a(){return{restrict:"A",bindToController:{partIndex:"=sgZoomableImage"},controller:b}}function b(a,b){var c=this;this.$postLink=function(){b.registerImage(a),a.on("click",this.showImage)},this.showImage=function(a){"IMG"==a.target.tagName&&b.showGallery(a,c.partIndex)}}b.$inject=["$element","ImageGallery"],angular.module("SOGo.MailerUI").directive("sgZoomableImage",a)}();
//# sourceMappingURL=Mailer.services.js.map