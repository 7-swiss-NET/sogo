{"version":3,"sources":["Contacts/AddressBook.service.js","Contacts/Card.service.js"],"names":["AddressBook","futureAddressBookData","then","this","init","name","id","newAddressBookData","$$resource","create","$unwrap","acls","objectEditor","objectCreator","objectEraser","$acl","$$Acl","$factory","$q","$timeout","$log","Settings","AddressBook_PRELOAD","Resource","Card","Acl","Preferences","angular","extend","PRELOAD","activeUser","$Card","$Preferences","$query","search","value","sort","asc","selectedFolder","$refreshTimeout","ready","settings","Contact","SortingState","parseInt","module","e","constant","LOOKAHEAD","SIZE","factory","$filterAll","options","excludedCards","params","isUndefined","$cards","fetch","response","results","card","index","compareIds","data","_","filter","contacts","find","length","splice","each","debug","when","$add","addressbook","list","sibling","i","isSubscription","$subscriptions","$addressbooks","o","localeCompare","indexOf","pluck","$findAll","_this","$remotes","forEach","isRemote","push","union","$find","addressbookId","$subscribe","uid","path","userResource","addressbookData","prototype","$$cards","$isLoading","idsMap","key","isOwned","isSuperUser","owner","login","$id","$futureAddressBookData","getLength","getItemAtIndex","$lastVisibleIndex","Math","max","$loadCard","endIndex","ids","futureHeadersData","cardId","startIndex","loaded","isDefined","$loaded","STATUS","NOT_LOADED","min","LOADED","LOADING","join","post","$unwrapHeaders","isSelectedCard","selectedCard","$selectedCount","count","selected","$startRefreshTimeout","cancel","refreshViewCheck","defaults","SOGoRefreshViewCheck","f","bind","$reload","timeInterval","$filter","query","dry","copy","partial","futureData","fields","idFieldIndex","cards","invoke","headers","oldIndex","removedCards","findIndex","object","$rename","$save","$delete","promise","d","defer","remove","resolve","reject","$deleteCards","uids","map","difference","$copyCards","folder","save","$omit","$getCard","fullCard","cachedCard","$futureCardData","$topIndex","reduce","isError","isObject","j","cardHeaders","futureCardData","pid","newCardData","newguid","isNew","$TEL_TYPES","$EMAIL_TYPES","$URL_TYPES","$ADDRESS_TYPES","Card_STATUS","Gravatar","$gravatar","SOGoContactsCategories","$categories","SOGoAlternateAvatar","$alternateAvatar","$unwrapCollection","filterCategories","re","RegExp","category","collection","refs","categories","$$fullname","$fullname","$$email","$preferredEmail","$$image","image","no_404","isgroup","c_component","c_name","empty","action","birthday","$birthday","$mdDateLocaleProvider","formatDate","$shadowData","attribute","names","fn","c_cn","c_givenname","nickname","c_sn","c_org","emails","$description","description","title","role","orgUnits","unit","email","test","type","$shortFormat","fullname","$isCard","$isList","$addOrgUnit","orgUnit","$addEmail","$addScreenName","screenName","c_screenname","$addPhone","phones","$addUrl","url","urls","$addAddress","postoffice","street","street2","locality","region","country","postalcode","addresses","$addMember","$reset","reference","Date","deep","getTime","toString","desc"],"mappings":"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","file":"Contacts.services.js","sourcesContent":[" /* -*- Mode: javascript; indent-tabs-mode: nil; c-basic-offset: 2 -*- */\n\n(function() {\n  'use strict';\n\n  /**\n   * @name AddressBook\n   * @constructor\n   * @param {object} futureAddressBookData - either an object literal or a promise\n   */\n  function AddressBook(futureAddressBookData) {\n    // Data is immediately available\n    if (typeof futureAddressBookData.then !== 'function') {\n      this.init(futureAddressBookData);\n      if (this.name && !this.id) {\n        // Create a new addressbook on the server\n        var newAddressBookData = AddressBook.$$resource.create('createFolder', this.name);\n        this.$unwrap(newAddressBookData);\n        this.acls = {'objectEditor': 1, 'objectCreator': 1, 'objectEraser': 1};\n      }\n      else if (this.id) {\n        this.$acl = new AddressBook.$$Acl('Contacts/' + this.id);\n      }\n    }\n    else {\n      // The promise will be unwrapped first\n      this.$unwrap(futureAddressBookData);\n    }\n  }\n\n  /**\n   * @memberof AddressBook\n   * @desc The factory we'll use to register with Angular\n   * @returns the AddressBook constructor\n   */\n  AddressBook.$factory = ['$q', '$timeout', '$log', 'sgSettings', 'sgAddressBook_PRELOAD', 'Resource', 'Card', 'Acl', 'Preferences', function($q, $timeout, $log, Settings, AddressBook_PRELOAD, Resource, Card, Acl, Preferences) {\n    angular.extend(AddressBook, {\n      $q: $q,\n      $timeout: $timeout,\n      $log: $log,\n      PRELOAD: AddressBook_PRELOAD,\n      $$resource: new Resource(Settings.activeUser('folderURL') + 'Contacts', Settings.activeUser()),\n      $Card: Card,\n      $$Acl: Acl,\n      $Preferences: Preferences,\n      $query: {search: 'name_or_address', value: '', sort: 'c_cn', asc: 1},\n      activeUser: Settings.activeUser(),\n      selectedFolder: null,\n      $refreshTimeout: null\n    });\n    // Initialize sort parameters from user's settings\n    Preferences.ready().then(function() {\n      if (Preferences.settings.Contact.SortingState) {\n        AddressBook.$query.sort = Preferences.settings.Contact.SortingState[0];\n        AddressBook.$query.asc = parseInt(Preferences.settings.Contact.SortingState[1]);\n      }\n    });\n    return AddressBook; // return constructor\n  }];\n\n  /**\n   * @module SOGo.ContactsUI\n   * @desc Factory registration of AddressBook in Angular module.\n   */\n  try {\n    angular.module('SOGo.ContactsUI');\n  }\n  catch(e) {\n    angular.module('SOGo.ContactsUI', ['SOGo.Common', 'SOGo.PreferencesUI']);\n  }\n  angular.module('SOGo.ContactsUI')\n    .constant('sgAddressBook_PRELOAD', {\n      LOOKAHEAD: 50,\n      SIZE: 100\n    })\n    .factory('AddressBook', AddressBook.$factory);\n\n  /**\n   * @memberof AddressBook\n   * @desc Search for cards among all addressbooks matching some criterias.\n   * @param {string} search - the search string to match\n   * @param {object} [options] - additional options to the query (excludeGroups and excludeLists)\n   * @param {object[]} excludedCards - a list of Card objects that must be excluded from the results\n   * @returns a collection of Cards instances\n   */\n  AddressBook.$filterAll = function(search, options, excludedCards) {\n    var params = { search: search };\n\n    if (!search) {\n      // No query specified\n      AddressBook.$cards = [];\n      return AddressBook.$q.when(AddressBook.$cards);\n    }\n    if (angular.isUndefined(AddressBook.$cards)) {\n      // First session query\n      AddressBook.$cards = [];\n    }\n\n    angular.extend(params, options);\n\n    return AddressBook.$$resource.fetch(null, 'allContactSearch', params).then(function(response) {\n      var results, card, index,\n          compareIds = function(data) {\n            return this.id == data.id;\n          };\n      if (excludedCards) {\n        // Remove excluded cards from results\n        results = _.filter(response.contacts, function(data) {\n          return _.isUndefined(_.find(excludedCards, compareIds, data));\n        });\n      }\n      else {\n        results = response.contacts;\n      }\n      // Remove cards that no longer match the search query\n      for (index = AddressBook.$cards.length - 1; index >= 0; index--) {\n        card = AddressBook.$cards[index];\n        if (_.isUndefined(_.find(results, compareIds, card))) {\n          AddressBook.$cards.splice(index, 1);\n        }\n      }\n      // Add new cards matching the search query\n      _.each(results, function(data, index) {\n        if (_.isUndefined(_.find(AddressBook.$cards, compareIds, data))) {\n          var card = new AddressBook.$Card(data, search);\n          AddressBook.$cards.splice(index, 0, card);\n        }\n      });\n      AddressBook.$log.debug(AddressBook.$cards);\n      return AddressBook.$cards;\n    });\n  };\n\n  /**\n   * @memberof AddressBook\n   * @desc Add a new addressbook to the static list of addressbooks\n   * @param {AddressBook} addressbook - an Addressbook object instance\n   */\n  AddressBook.$add = function(addressbook) {\n    // Insert new addressbook at proper index\n    var list, sibling, i;\n\n    list = addressbook.isSubscription? this.$subscriptions : this.$addressbooks;\n    sibling = _.find(list, function(o) {\n      return (addressbook.id == 'personal' ||\n              (o.id != 'personal' &&\n               o.name.localeCompare(addressbook.name) === 1));\n    });\n    i = sibling ? _.indexOf(_.pluck(list, 'id'), sibling.id) : 1;\n    list.splice(i, 0, addressbook);\n  };\n\n  /**\n   * @memberof AddressBook\n   * @desc Set or get the list of addressbooks. Will instantiate a new AddressBook object for each item.\n   * @param {array} [data] - the metadata of the addressbooks\n   * @returns the list of addressbooks\n   */\n  AddressBook.$findAll = function(data) {\n    var _this = this;\n    if (data) {\n      this.$addressbooks = [];\n      this.$subscriptions = [];\n      this.$remotes = [];\n      // Instanciate AddressBook objects\n      angular.forEach(data, function(o, i) {\n        var addressbook = new AddressBook(o);\n        if (addressbook.isRemote)\n          _this.$remotes.push(addressbook);\n        else if (addressbook.isSubscription)\n          _this.$subscriptions.push(addressbook);\n        else\n          _this.$addressbooks.push(addressbook);\n      });\n    }\n    return _.union(this.$addressbooks, this.$subscriptions, this.$remotes);\n  };\n\n  /**\n   * @memberOf AddressBook\n   * @desc Fetch list of cards and return an AddressBook instance.\n   * @param {string} addressbookId - the addressbook identifier\n   * @returns an AddressBook object instance\n   */\n  AddressBook.$find = function(addressbookId) {\n    var futureAddressBookData = AddressBook.$Preferences.ready().then(function() {\n      return AddressBook.$$resource.fetch(addressbookId, 'view', AddressBook.$query);\n    });\n    return new AddressBook(futureAddressBookData);\n  };\n\n  /**\n   * @memberOf AddressBook\n   * @desc Subscribe to another user's addressbook and add it to the list of addressbooks.\n   * @param {string} uid - user id\n   * @param {string} path - path of folder for specified user\n   * @returns a promise of the HTTP query result\n   */\n  AddressBook.$subscribe = function(uid, path) {\n    var _this = this;\n    return AddressBook.$$resource.userResource(uid).fetch(path, 'subscribe').then(function(addressbookData) {\n      var addressbook = new AddressBook(addressbookData);\n      if (_.isUndefined(_.find(_this.$subscriptions, function(o) {\n        return o.id == addressbookData.id;\n      }))) {\n        // Not already subscribed\n        AddressBook.$add(addressbook);\n      }\n      return addressbook;\n    });\n  };\n\n  /**\n   * @function init\n   * @memberof AddressBook.prototype\n   * @desc Extend instance with new data and compute additional attributes.\n   * @param {object} data - attributes of addressbook\n   */\n  AddressBook.prototype.init = function(data, options) {\n    var _this = this;\n    if (!this.$$cards) {\n      // Array of cards for \"dry\" searches (see $filter)\n      this.$$cards = [];\n    }\n    this.$isLoading = true;\n    this.idsMap = {};\n    this.$cards = []; // TODO Keep the \"selected\" state of cards\n    // Extend instance with all attributes of data except headers\n    angular.forEach(data, function(value, key) {\n      if (key != 'headers' && key != 'cards') {\n        _this[key] = value;\n      }\n    });\n    // Add 'isOwned' and 'isSubscription' attributes based on active user (TODO: add it server-side?)\n    this.isOwned = AddressBook.activeUser.isSuperUser || this.owner == AddressBook.activeUser.login;\n    this.isSubscription = !this.isRemote && this.owner != AddressBook.activeUser.login;\n  };\n\n  /**\n   * @function $id\n   * @memberof AddressBook.prototype\n   * @desc Resolve the addressbook id.\n   * @returns a promise of the addressbook id\n   */\n  AddressBook.prototype.$id = function() {\n    if (this.id) {\n      // Object already unwrapped\n      return AddressBook.$q.when(this.id);\n    }\n    else {\n      // Wait until object is unwrapped\n      return this.$futureAddressBookData.then(function(addressbook) {\n        return addressbook.id;\n      });\n    }\n  };\n\n  /**\n   * @function getLength\n   * @memberof AddressBook.prototype\n   * @desc Used by md-virtual-repeat / md-on-demand\n   * @returns the number of cards in the addressbook\n   */\n  AddressBook.prototype.getLength = function() {\n    return this.$cards.length;\n  };\n\n  /**\n   * @function getItemAtIndex\n   * @memberof AddressBook.prototype\n   * @desc Used by md-virtual-repeat / md-on-demand\n   * @returns the card at the specified index\n   */\n  AddressBook.prototype.getItemAtIndex = function(index) {\n    var card;\n\n    if (!this.$isLoading && index >= 0 && index < this.$cards.length) {\n      card = this.$cards[index];\n      this.$lastVisibleIndex = Math.max(0, index - 3); // Magic number is NUM_EXTRA from virtual-repeater.js\n\n      if (this.$loadCard(card))\n        return card;\n    }\n    return null;\n  };\n\n  /**\n   * @function $loadCard\n   * @memberof AddressBook.prototype\n   * @desc Check if the card is loaded and in any case, fetch more cards headers from the server.\n   * @returns true if the card metadata are already fetched\n   */\n  AddressBook.prototype.$loadCard = function(card) {\n    var cardId = card.id,\n        startIndex = this.idsMap[cardId],\n        endIndex,\n        index,\n        max = this.$cards.length,\n        loaded = false,\n        ids,\n        futureHeadersData;\n\n    if (angular.isUndefined(this.ids) && card.id) {\n      loaded = true;\n    }\n    else if (angular.isDefined(startIndex) && startIndex < this.$cards.length) {\n      // Index is valid\n      if (card.$loaded != AddressBook.$Card.STATUS.NOT_LOADED) {\n        // Card headers are loaded or data is coming\n        loaded = true;\n      }\n\n      // Preload more headers if possible\n      endIndex = Math.min(startIndex + AddressBook.PRELOAD.LOOKAHEAD, max - 1);\n      if (this.$cards[endIndex].$loaded != AddressBook.$Card.STATUS.NOT_LOADED) {\n        index = Math.max(startIndex - AddressBook.PRELOAD.LOOKAHEAD, 0);\n        if (this.$cards[index].$loaded != AddressBook.$Card.STATUS.LOADED) {\n          // Previous cards not loaded; preload more headers further up\n          endIndex = startIndex;\n          startIndex = Math.max(startIndex - AddressBook.PRELOAD.SIZE, 0);\n        }\n      }\n      else\n        // Next cards not load; preload more headers further down\n        endIndex = Math.min(startIndex + AddressBook.PRELOAD.SIZE, max - 1);\n\n      if (this.$cards[startIndex].$loaded == AddressBook.$Card.STATUS.NOT_LOADED ||\n          this.$cards[endIndex].$loaded == AddressBook.$Card.STATUS.NOT_LOADED) {\n\n        for (ids = []; startIndex < endIndex && startIndex < max; startIndex++) {\n          if (this.$cards[startIndex].$loaded != AddressBook.$Card.STATUS.NOT_LOADED) {\n            // Card at this index is already loaded; increase the end index\n            endIndex++;\n          }\n          else {\n            // Card at this index will be loaded\n            ids.push(this.$cards[startIndex].id);\n            this.$cards[startIndex].$loaded = AddressBook.$Card.STATUS.LOADING;\n          }\n        }\n\n        AddressBook.$log.debug('Loading Ids ' + ids.join(' ') + ' (' + ids.length + ' cards)');\n        if (ids.length > 0) {\n          futureHeadersData = AddressBook.$$resource.post(this.id, 'headers', {ids: ids});\n          this.$unwrapHeaders(futureHeadersData);\n        }\n      }\n    }\n    return loaded;\n  };\n\n  /**\n   * @function isSelectedCard\n   * @memberof AddressBook.prototype\n   * @desc Check if the specified card is selected.\n   * @param {string} CardId\n   * @returns true if the specified card is selected\n   */\n  AddressBook.prototype.isSelectedCard = function(cardId) {\n    return this.selectedCard == cardId;\n  };\n\n  /**\n   * @function $selectedCount\n   * @memberof AddressBook.prototype\n   * @desc Return the number of cards selected by the user.\n   * @returns the number of selected cards\n   */\n  AddressBook.prototype.$selectedCount = function() {\n    var count;\n\n    count = 0;\n    if (this.$cards) {\n      count = (_.filter(this.$cards, function(card) { return card.selected; })).length;\n    }\n    return count;\n  };\n\n  /**\n   * @function $startRefreshTimeout\n   * @memberof AddressBook.prototype\n   * @desc Starts the refresh timeout for the current selected address book\n   */\n  AddressBook.prototype.$startRefreshTimeout = function() {\n    var _this = this;\n\n    if (AddressBook.$refreshTimeout)\n      AddressBook.$timeout.cancel(AddressBook.$refreshTimeout);\n\n    AddressBook.$Preferences.ready().then(function() {\n      // Restart the refresh timer, if needed\n      var refreshViewCheck = AddressBook.$Preferences.defaults.SOGoRefreshViewCheck;\n      if (refreshViewCheck && refreshViewCheck != 'manually') {\n        var f = angular.bind(_this, AddressBook.prototype.$reload);\n        AddressBook.$refreshTimeout = AddressBook.$timeout(f, refreshViewCheck.timeInterval()*1000);\n      }\n    });\n  };\n\n  /**\n   * @function $reload\n   * @memberof AddressBook.prototype\n   * @desc Reload list of cards\n   * @returns a promise of the Cards instances\n   */\n  AddressBook.prototype.$reload = function() {\n    var _this = this;\n\n    this.$startRefreshTimeout();\n    return this.$filter();\n  };\n\n    /**\n   * @function $filter\n   * @memberof AddressBook.prototype\n   * @desc Search for cards matching some criterias\n   * @param {string} search - the search string to match\n   * @param {object} [options] - additional options to the query (dry, excludeList)\n   * @returns a collection of Cards instances\n   */\n  AddressBook.prototype.$filter = function(search, options, excludedCards) {\n    var _this = this, query,\n        dry = options && options.dry;\n\n    if (dry) {\n      // Don't keep a copy of the query in dry mode\n      query = angular.copy(AddressBook.$query);\n    }\n    else {\n      this.$isLoading = true;\n      query = AddressBook.$query;\n      if (!this.isRemote) query.partial = 1;\n    }\n\n    return AddressBook.$Preferences.ready().then(function() {\n      if (options) {\n        angular.extend(query, options);\n        if (dry) {\n          if (!search) {\n            // No query specified\n            _this.$$cards = [];\n            return AddressBook.$q.when(_this.$$cards);\n          }\n        }\n      }\n\n      if (angular.isDefined(search))\n        query.value = search;\n\n      return _this.$id().then(function(addressbookId) {\n        var futureData = AddressBook.$$resource.fetch(addressbookId, 'view', query);\n\n        if (dry) {\n          futureData.then(function(response) {\n            var results, headers, card, index, fields, idFieldIndex,\n                cards = _this.$$cards,\n                compareIds = function(card) {\n                  return this == card.id;\n                };\n\n            // First entry of 'headers' are keys\n            fields = _.invoke(response.headers[0], 'toLowerCase');\n            idFieldIndex = fields.indexOf('id');\n            response.headers.splice(0, 1);\n\n            if (excludedCards)\n              // Remove excluded cards from results\n              results = _.filter(response.ids, function(id) {\n                return _.isUndefined(_.find(excludedCards, compareIds, id));\n              });\n            else\n              results = response.ids;\n\n            // Remove cards that no longer match the search query\n            for (index = cards.length - 1; index >= 0; index--) {\n              card = cards[index];\n              if (_.isUndefined(_.find(results, compareIds, card.id))) {\n                cards.splice(index, 1);\n              }\n            }\n\n            // Add new cards matching the search query\n            _.each(results, function(cardId, index) {\n              if (_.isUndefined(_.find(cards, compareIds, cardId))) {\n                var data = { id: cardId };\n                var card = new AddressBook.$Card(data, search);\n                cards.splice(index, 0, card);\n              }\n            });\n\n            // Respect the order of the results\n            _.each(results, function(cardId, index) {\n              var oldIndex, removedCards;\n              if (cards[index].id != cardId) {\n                oldIndex = _.findIndex(cards, compareIds, cardId);\n                removedCards = cards.splice(oldIndex, 1);\n                cards.splice(index, 0, removedCards[0]);\n              }\n            });\n\n            // Extend Card objects with received headers\n            _.each(response.headers, function(data) {\n              var card, index = _.findIndex(cards, compareIds, data[idFieldIndex]);\n              if (index > -1) {\n                card = _.object(fields, data);\n                cards[index].init(card, search);\n              }\n            });\n\n            _this.$isLoading = false;\n            return cards;\n          });\n        }\n        else {\n          // Unwrap promise and instantiate or extend Cards objets\n          _this.$unwrap(futureData);\n        }\n      });\n    });\n  };\n\n  /**\n   * @function $rename\n   * @memberof AddressBook.prototype\n   * @desc Rename the addressbook and keep the list sorted\n   * @param {string} name - the new name\n   * @returns a promise of the HTTP operation\n   */\n  AddressBook.prototype.$rename = function(name) {\n    var i = _.indexOf(_.pluck(AddressBook.$addressbooks, 'id'), this.id);\n    this.name = name;\n    AddressBook.$addressbooks.splice(i, 1);\n    AddressBook.$add(this);\n    return this.$save();\n  };\n\n  /**\n   * @function $delete\n   * @memberof AddressBook.prototype\n   * @desc Delete the addressbook from the server and the static list of addressbooks.\n   * @returns a promise of the HTTP operation\n   */\n  AddressBook.prototype.$delete = function() {\n    var _this = this,\n        d = AddressBook.$q.defer(),\n        list,\n        promise;\n\n    if (this.isSubscription) {\n      promise = AddressBook.$$resource.fetch(this.id, 'unsubscribe');\n      list = AddressBook.$subscriptions;\n    }\n    else {\n      promise = AddressBook.$$resource.remove(this.id);\n      list = AddressBook.$addressbooks;\n    }\n\n    promise.then(function() {\n      var i = _.indexOf(_.pluck(list, 'id'), _this.id);\n      list.splice(i, 1);\n      d.resolve();\n    }, d.reject);\n    return d.promise;\n  };\n\n  /**\n   * @function $deleteCards\n   * @memberof AddressBook.prototype\n   * @desc Delete multiple cards from addressbook.\n   * @return a promise of the HTTP operation\n   */\n  AddressBook.prototype.$deleteCards = function(cards) {\n\n    var uids = _.map(cards, function(card) { return card.id; });\n    var _this = this;\n    \n    return AddressBook.$$resource.post(this.id, 'batchDelete', {uids: uids}).then(function() {\n      _this.$cards = _.difference(_this.$cards, cards);\n    });\n  };\n\n  /**\n   * @function $copyCards\n   * @memberof AddressBook.prototype\n   * @desc Copy multiple cards from addressbook to an other one.\n   * @return a promise of the HTTP operation\n   */\n  AddressBook.prototype.$copyCards = function(cards, folder) {\n    var uids = _.map(cards, function(card) { return card.id; });\n    return AddressBook.$$resource.post(this.id, 'copy', {uids: uids, folder: folder});\n  };\n\n  /**\n   * @function $save\n   * @memberof AddressBook.prototype\n   * @desc Save the addressbook to the server. This currently can only affect the name of the addressbook.\n   * @returns a promise of the HTTP operation\n   */\n  AddressBook.prototype.$save = function() {\n    return AddressBook.$$resource.save(this.id, this.$omit()).then(function(data) {\n      return data;\n    });\n  };\n\n  /**\n   * @function $getCard\n   * @memberof AddressBook.prototype\n   * @desc Fetch the card attributes from the server.\n   * @returns a promise of the HTTP operation\n   */\n  AddressBook.prototype.$getCard = function(cardId) {\n    var _this = this;\n\n    return this.$id().then(function(addressbookId) {\n      var fullCard,\n          cachedCard = _.find(_this.$cards, function(data) {\n            return cardId == data.id;\n          });\n\n      if (cachedCard && cachedCard.$futureCardData)\n        // Full card is available\n        return cachedCard;\n\n      fullCard = AddressBook.$Card.$find(addressbookId, cardId);\n      fullCard.$id().then(function(cardId) {\n        // Extend the Card object of the addressbook list with the full card description\n        if (cachedCard)\n          angular.extend(cachedCard, fullCard);\n      });\n      return fullCard;\n    });\n  };\n\n  /**\n   * @function $unwrap\n   * @memberof AddressBook.prototype\n   * @desc Unwrap a promise and instanciate new Card objects using received data.\n   * @param {promise} futureAddressBookData - a promise of the AddressBook's data\n   */\n  AddressBook.prototype.$unwrap = function(futureAddressBookData) {\n    var _this = this;\n\n    this.$isLoading = true;\n\n    // Expose and resolve the promise\n    this.$futureAddressBookData = futureAddressBookData.then(function(response) {\n      return AddressBook.$timeout(function() {\n        var headers;\n\n        if (!response.ids || _this.$topIndex > response.ids.length - 1)\n          _this.$topIndex = 0;\n\n        // Extend AddressBook instance from data of addressbooks list.\n        // Will inherit attributes such as isEditable and isRemote.\n        angular.forEach(AddressBook.$findAll(), function(o, i) {\n          if (o.id == response.id) {\n            angular.extend(_this, o);\n          }\n        });\n\n        // Extend AddressBook instance with received data\n        _this.init(response);\n\n        if (_this.ids) {\n          AddressBook.$log.debug('unwrapping ' + _this.ids.length + ' cards');\n\n          // Instanciate Card objects\n          _.reduce(_this.ids, function(cards, card, i) {\n            var data = { id: card };\n\n            // Build map of ID <=> index\n            _this.idsMap[data.id] = i;\n\n            cards.push(new AddressBook.$Card(data));\n\n            return cards;\n          }, _this.$cards);\n        }\n\n        if (response.headers) {\n          // First entry of 'headers' are keys\n          headers = _.invoke(response.headers[0], 'toLowerCase');\n          response.headers.splice(0, 1);\n\n          if (_this.ids) {\n            // Extend Card objects with received headers\n            _.each(response.headers, function(data) {\n              var o = _.object(headers, data),\n                  i = _this.idsMap[o.id];\n              _this.$cards[i].init(o);\n            });\n          }\n          else {\n            // Instanciate Card objects\n            _this.$cards = [];\n            angular.forEach(response.headers, function(data) {\n              var o = _.object(headers, data);\n              _this.$cards.push(new AddressBook.$Card(o));\n            });\n          }\n        }\n\n        // Instanciate Acl object\n        _this.$acl = new AddressBook.$$Acl('Contacts/' + _this.id);\n\n        _this.$startRefreshTimeout();\n\n        _this.$isLoading = false;\n\n        AddressBook.$log.debug('addressbook ' + _this.id + ' ready');\n\n        return _this;\n      });\n    }, function(data) {\n      _this.isError = true;\n      if (angular.isObject(data)) {\n        AddressBook.$timeout(function() {\n          angular.extend(_this, data);\n        });\n      }\n    });\n  };\n\n  /**\n   * @function $unwrapHeaders\n   * @memberof AddressBook.prototype\n   * @desc Unwrap a promise and extend matching Card objects with received data.\n   * @param {promise} futureHeadersData - a promise of the metadata of some cards\n   */\n  AddressBook.prototype.$unwrapHeaders = function(futureHeadersData) {\n    var _this = this;\n\n    futureHeadersData.then(function(data) {\n      AddressBook.$timeout(function() {\n        var headers, j;\n        if (data.length > 0) {\n          // First entry of 'headers' are keys\n          headers = _.invoke(data[0], 'toLowerCase');\n          data.splice(0, 1);\n          _.each(data, function(cardHeaders) {\n            cardHeaders = _.object(headers, cardHeaders);\n            j = _this.idsMap[cardHeaders.id];\n            if (angular.isDefined(j)) {\n              _this.$cards[j].init(cardHeaders);\n            }\n          });\n        }\n      });\n    });\n  };\n\n  /**\n   * @function $omit\n   * @memberof AddressBook.prototype\n   * @desc Return a sanitized object used to send to the server.\n   * @return an object literal copy of the Addressbook instance\n   */\n  AddressBook.prototype.$omit = function() {\n    var addressbook = {};\n    angular.forEach(this, function(value, key) {\n      if (key != 'constructor' &&\n          key != 'ids' &&\n          key[0] != '$') {\n        addressbook[key] = value;\n      }\n    });\n    return addressbook;\n  };\n})();\n","/* -*- Mode: javascript; indent-tabs-mode: nil; c-basic-offset: 2 -*- */\n\n(function() {\n  'use strict';\n\n  /**\n   * @name Card\n   * @constructor\n   * @param {object} futureCardData\n   * @param {string} [partial]\n   */\n  function Card(futureCardData, partial) {\n\n    // Data is immediately available\n    if (typeof futureCardData.then !== 'function') {\n      this.init(futureCardData, partial);\n      if (this.pid && !this.id) {\n        // Prepare for the creation of a new card;\n        // Get UID from the server.\n        var newCardData = Card.$$resource.newguid(this.pid);\n        this.$unwrap(newCardData);\n        this.isNew = true;\n      }\n    }\n    else {\n      // The promise will be unwrapped first\n      this.$unwrap(futureCardData);\n    }\n  }\n\n  Card.$TEL_TYPES = ['work', 'home', 'cell', 'fax', 'pager'];\n  Card.$EMAIL_TYPES = ['work', 'home', 'pref'];\n  Card.$URL_TYPES = ['work', 'home', 'pref'];\n  Card.$ADDRESS_TYPES = ['work', 'home'];\n\n  /**\n   * @memberof Card\n   * @desc The factory we'll use to register with Angular.\n   * @returns the Card constructor\n   */\n  Card.$factory = ['$timeout', 'sgSettings', 'sgCard_STATUS', 'Resource', 'Preferences', 'Gravatar', function($timeout, Settings, Card_STATUS, Resource, Preferences, Gravatar) {\n    angular.extend(Card, {\n      STATUS: Card_STATUS,\n      $$resource: new Resource(Settings.activeUser('folderURL') + 'Contacts', Settings.activeUser()),\n      $timeout: $timeout,\n      $gravatar: Gravatar,\n      $Preferences: Preferences\n    });\n    // Initialize categories from user's defaults\n    Preferences.ready().then(function() {\n      if (Preferences.defaults.SOGoContactsCategories) {\n        Card.$categories = Preferences.defaults.SOGoContactsCategories;\n      }\n      if (Preferences.defaults.SOGoAlternateAvatar)\n        Card.$alternateAvatar = Preferences.defaults.SOGoAlternateAvatar;\n    });\n\n    return Card; // return constructor\n  }];\n\n  /**\n   * @module SOGo.ContactsUI\n   * @desc Factory registration of Card in Angular module.\n   */\n  try {\n    angular.module('SOGo.ContactsUI');\n  }\n  catch(e) {\n    angular.module('SOGo.ContactsUI', ['SOGo.Common', 'SOGo.PreferencesUI']);\n  }\n  angular.module('SOGo.ContactsUI')\n    .constant('sgCard_STATUS', {\n      NOT_LOADED: 0,\n      LOADING: 1,\n      LOADED: 2\n    })\n    .factory('Card', Card.$factory);\n\n  /**\n   * @memberof Card\n   * @desc Fetch a card from a specific addressbook.\n   * @param {string} addressbookId - the addressbook ID\n   * @param {string} cardId - the card ID\n   * @see {@link AddressBook.$getCard}\n   */\n  Card.$find = function(addressbookId, cardId) {\n    var futureCardData = this.$$resource.fetch([addressbookId, cardId].join('/'), 'view');\n\n    if (cardId) return new Card(futureCardData); // a single card\n\n    return Card.$unwrapCollection(futureCardData); // a collection of cards\n  };\n\n  /**\n   * @function filterCategories\n   * @memberof Card.prototype\n   * @desc Search for categories matching some criterias\n   * @param {string} search - the search string to match\n   * @returns a collection of strings\n   */\n  Card.filterCategories = function(query) {\n    var re = new RegExp(query, 'i');\n    return _.map(_.filter(Card.$categories, function(category) {\n      return category.search(re) != -1;\n    }), function(category) {\n      return { value: category };\n    });\n  };\n\n  /**\n   * @memberof Card\n   * @desc Unwrap to a collection of Card instances.\n   * @param {object} futureCardData\n   */\n  Card.$unwrapCollection = function(futureCardData) {\n    var collection = {};\n\n    collection.$futureCardData = futureCardData;\n\n    futureCardData.then(function(cards) {\n      Card.$timeout(function() {\n        angular.forEach(cards, function(data, index) {\n          collection[data.id] = new Card(data);\n        });\n      });\n    });\n\n    return collection;\n  };\n\n  /**\n   * @function init\n   * @memberof Card.prototype\n   * @desc Extend instance with required attributes and new data.\n   * @param {object} data - attributes of card\n   */\n  Card.prototype.init = function(data, partial) {\n    this.refs = [];\n    this.categories = [];\n    angular.extend(this, data);\n    if (!this.$$fullname)\n      this.$$fullname = this.$fullname();\n    if (!this.$$email)\n      this.$$email = this.$preferredEmail(partial);\n    if (!this.$$image)\n      this.$$image = this.image || Card.$gravatar(this.$preferredEmail(partial), 32, Card.$alternateAvatar, {no_404: true});\n    if (this.isgroup)\n      this.c_component = 'vlist';\n    this.$loaded = angular.isDefined(this.c_name)? Card.STATUS.LOADED : Card.STATUS.NOT_LOADED;\n\n    // An empty attribute to trick md-autocomplete when adding attendees from the appointment editor\n    this.empty = ' ';\n  };\n\n  /**\n   * @function $id\n   * @memberof Card.prototype\n   * @desc Return the card ID.\n   * @returns the card ID\n   */\n  Card.prototype.$id = function() {\n    return this.$futureCardData.then(function(data) {\n      return data.id;\n    });\n  };\n\n  /**\n   * @function $save\n   * @memberof Card.prototype\n   * @desc Save the card to the server.\n   */\n  Card.prototype.$save = function() {\n    var _this = this,\n        action = 'saveAsContact';\n\n    if (this.c_component == 'vlist') action = 'saveAsList';\n\n    return Card.$$resource.save([this.pid, this.id || '_new_'].join('/'),\n                                this.$omit(),\n                                { action: action })\n      .then(function(data) {\n        // Format birthdate\n        if (_this.birthday)\n          _this.$birthday = Card.$Preferences.$mdDateLocaleProvider.formatDate(_this.birthday);\n        // Make a copy of the data for an eventual reset\n        _this.$shadowData = _this.$omit(true);\n        return data;\n      });\n  };\n\n  Card.prototype.$delete = function(attribute, index) {\n    if (attribute) {\n      if (index > -1 && this[attribute].length > index) {\n        this[attribute].splice(index, 1);\n      }\n      else\n        delete this[attribute];\n    }\n    else {\n      // No arguments -- delete card\n      return Card.$$resource.remove([this.pid, this.id].join('/'));\n    }\n  };\n\n  Card.prototype.$fullname = function() {\n    var fn = this.c_cn || '', names;\n    if (fn.length === 0) {\n      names = [];\n      if (this.c_givenname && this.c_givenname.length > 0)\n        names.push(this.c_givenname);\n      if (this.nickname && this.nickname.length > 0)\n        names.push('<em>' + this.nickname + '</em>');\n      if (this.c_sn && this.c_sn.length > 0)\n        names.push(this.c_sn);\n      if (names.length > 0)\n        fn = names.join(' ');\n      else if (this.c_org && this.c_org.length > 0) {\n        fn = this.c_org;\n      }\n      else if (this.emails && this.emails.length > 0) {\n        fn = _.find(this.emails, function(i) { return i.value !== ''; }).value;\n      }\n      else if (this.c_cn && this.c_cn.length > 0) {\n        fn = this.c_cn;\n      }\n    }\n\n    return fn;\n  };\n\n  Card.prototype.$description = function() {\n    var description = [];\n    if (this.title) description.push(this.title);\n    if (this.role) description.push(this.role);\n    if (this.orgUnits && this.orgUnits.length > 0)\n      _.forEach(this.orgUnits, function(unit) {\n        if (unit.value !== '')\n          description.push(unit.value);\n      });\n    if (this.c_org) description.push(this.c_org);\n    if (this.description) description.push(this.description);\n\n    return description.join(', ');\n  };\n\n  /**\n   * @function $preferredEmail\n   * @memberof Card.prototype\n   * @desc Get the preferred email address.\n   * @param {string} [partial] - a partial string that the email must match\n   * @returns the first email address of type \"pref\" or the first address if none found\n   */\n  Card.prototype.$preferredEmail = function(partial) {\n    var email, re;\n    if (partial) {\n      re = new RegExp(partial, 'i');\n      email = _.find(this.emails, function(o) {\n        return re.test(o.value);\n      });\n    }\n    if (email) {\n      email = email.value;\n    }\n    else {\n      email = _.find(this.emails, function(o) {\n        return o.type == 'pref';\n      });\n      if (email) {\n        email = email.value;\n      }\n      else if (this.emails && this.emails.length) {\n        email = this.emails[0].value;\n      }\n      else {\n        email = '';\n      }\n    }\n\n    return email;\n  };\n\n  /**\n   * @function $shortFormat\n   * @memberof Card.prototype\n   * @param {string} [partial] - a partial string that the email must match\n   * @returns the fullname along with a matching email address in parentheses\n   */\n  Card.prototype.$shortFormat = function(partial) {\n    var fullname = [this.$$fullname],\n        email = this.$preferredEmail(partial);\n    if (email && email != this.$$fullname)\n      fullname.push(' <' + email + '>');\n    return fullname.join(' ');\n  };\n\n  Card.prototype.$isCard = function() {\n    return this.c_component == 'vcard';\n  };\n\n  Card.prototype.$isList = function() {\n    return this.c_component == 'vlist';\n  };\n\n  Card.prototype.$addOrgUnit = function(orgUnit) {\n    if (angular.isUndefined(this.orgUnits)) {\n      this.orgUnits = [{value: orgUnit}];\n    }\n    else {\n      for (var i = 0; i < this.orgUnits.length; i++) {\n        if (this.orgUnits[i].value == orgUnit) {\n          break;\n        }\n      }\n      if (i == this.orgUnits.length)\n        this.orgUnits.push({value: orgUnit});\n    }\n    return this.orgUnits.length - 1;\n  };\n\n  // Card.prototype.$addCategory = function(category) {\n  //   if (category) {\n  //     if (angular.isUndefined(this.categories)) {\n  //       this.categories = [{value: category}];\n  //     }\n  //     else {\n  //       for (var i = 0; i < this.categories.length; i++) {\n  //         if (this.categories[i].value == category) {\n  //           break;\n  //         }\n  //       }\n  //       if (i == this.categories.length)\n  //         this.categories.push({value: category});\n  //     }\n  //   }\n  // };\n\n  Card.prototype.$addEmail = function(type) {\n    if (angular.isUndefined(this.emails)) {\n      this.emails = [{type: type, value: ''}];\n    }\n    else if (_.isUndefined(_.find(this.emails, function(i) { return i.value === ''; }))) {\n      this.emails.push({type: type, value: ''});\n    }\n    return this.emails.length - 1;\n  };\n\n  Card.prototype.$addScreenName = function(screenName) {\n    this.c_screenname = screenName;\n  };\n\n  Card.prototype.$addPhone = function(type) {\n    if (angular.isUndefined(this.phones)) {\n      this.phones = [{type: type, value: ''}];\n    }\n    else if (_.isUndefined(_.find(this.phones, function(i) { return i.value === ''; }))) {\n      this.phones.push({type: type, value: ''});\n    }\n    return this.phones.length - 1;\n  };\n\n  Card.prototype.$addUrl = function(type, url) {\n    if (angular.isUndefined(this.urls)) {\n      this.urls = [{type: type, value: url}];\n    }\n    else if (_.isUndefined(_.find(this.urls, function(i) { return i.value == url; }))) {\n      this.urls.push({type: type, value: url});\n    }\n    return this.urls.length - 1;\n  };\n\n  Card.prototype.$addAddress = function(type, postoffice, street, street2, locality, region, country, postalcode) {\n    if (angular.isUndefined(this.addresses)) {\n      this.addresses = [{type: type, postoffice: postoffice, street: street, street2: street2, locality: locality, region: region, country: country, postalcode: postalcode}];\n    }\n    else if (!_.find(this.addresses, function(i) {\n      return i.street == street &&\n        i.street2 == street2 &&\n        i.locality == locality &&\n        i.country == country &&\n        i.postalcode == postalcode;\n    })) {\n      this.addresses.push({type: type, postoffice: postoffice, street: street, street2: street2, locality: locality, region: region, country: country, postalcode: postalcode});\n    }\n    return this.addresses.length - 1;\n  };\n\n  Card.prototype.$addMember = function(email) {\n    var card = new Card({email: email, emails: [{value: email}]}),\n        i;\n    if (angular.isUndefined(this.refs)) {\n      this.refs = [card];\n    }\n    else if (email.length === 0) {\n      this.refs.push(card);\n    }\n    else {\n      for (i = 0; i < this.refs.length; i++) {\n        if (this.refs[i].email == email) {\n          break;\n        }\n      }\n      if (i == this.refs.length)\n        this.refs.push(card);\n    }\n    return this.refs.length - 1;\n  };\n\n  /**\n   * @function $reset\n   * @memberof Card.prototype\n   * @desc Reset the original state the card's data.\n   */\n  Card.prototype.$reset = function() {\n    var _this = this;\n    angular.forEach(this, function(value, key) {\n      if (key != 'constructor' && key[0] != '$') {\n        delete _this[key];\n      }\n    });\n    angular.extend(this, this.$shadowData);\n    // Reinstanciate Card objects for list members\n    angular.forEach(this.refs, function(o, i) {\n      if (o.email) o.emails = [{value: o.email}];\n      _this.refs[i] = new Card(o);\n    });\n    this.$shadowData = this.$omit(true);\n  };\n\n  /**\n   * @function $updateMember\n   * @memberof Card.prototype\n   * @desc Update an existing list member from a Card instance.\n   * A list member has the following attribtues:\n   * - email\n   * - reference\n   * - fn\n   * @param {number} index\n   * @param {string} email\n   * @param {Card} card\n   */\n  // Card.prototype.$updateMember = function(index, email, card) {\n  //   var ref = {\n  //     email: email,\n  //     emails: [{value: email}],\n  //     reference: card.c_name,\n  //     c_cn: card.$fullname()\n  //   };\n  //   this.refs[index] = new Card(ref);\n  // };\n\n  /**\n   * @function $unwrap\n   * @memberof Card.prototype\n   * @desc Unwrap a promise and make a copy of the resolved data.\n   * @param {object} futureCardData - a promise of the Card's data\n   */\n  Card.prototype.$unwrap = function(futureCardData) {\n    var _this = this;\n\n    // Card is not loaded yet\n    this.$loaded = Card.STATUS.LOADING;\n\n    // Expose the promise\n    this.$futureCardData = futureCardData.then(function(data) {\n      _this.init(data);\n      // Instanciate Card objects for list members\n      angular.forEach(_this.refs, function(o, i) {\n        if (o.email) o.emails = [{value: o.email}];\n        o.id = o.reference;\n        _this.refs[i] = new Card(o);\n      });\n      if (_this.birthday) {\n        _this.birthday = new Date(_this.birthday * 1000);\n        _this.$birthday = Card.$Preferences.$mdDateLocaleProvider.formatDate(_this.birthday);\n      }\n      // Mark card as loaded\n      _this.$loaded = Card.STATUS.LOADED;\n      // Make a copy of the data for an eventual reset\n      _this.$shadowData = _this.$omit(true);\n\n      return _this;\n    });\n  };\n\n  /**\n   * @function $omit\n   * @memberof Card.prototype\n   * @desc Return a sanitized object used to send to the server.\n   * @param {boolean} [deep] - make a deep copy if true\n   * @return an object literal copy of the Card instance\n   */\n  Card.prototype.$omit = function(deep) {\n    var card = {};\n    angular.forEach(this, function(value, key) {\n      if (key == 'refs') {\n        card.refs = _.map(value, function(o) {\n          return o.$omit(deep);\n        });\n      }\n      else if (key != 'constructor' && key[0] != '$') {\n        if (deep)\n          card[key] = angular.copy(value);\n        else\n          card[key] = value;\n      }\n    });\n\n    // We convert back our birthday object\n    if (!deep) {\n      if (card.birthday)\n        card.birthday = card.birthday.getTime()/1000;\n      else\n        card.birthday = 0;\n    }\n\n    return card;\n  };\n\n  Card.prototype.toString = function() {\n    var desc = this.id + ' ' + this.$$fullname;\n\n    if (this.$$email)\n      desc += ' <' + this.$$email + '>';\n\n    return '[' + desc + ']';\n  };\n})();\n"]}