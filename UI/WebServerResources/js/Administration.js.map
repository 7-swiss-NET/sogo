{"version":3,"file":"Administration.js","sources":["Administration/Administration.app.js","Administration/AdministrationAclController.js","Administration/AdministrationController.js"],"names":["configure","$stateProvider","$urlRouterProvider","state","abstract","views","administration","templateUrl","controller","controllerAs","url","module","acl","resolve","stateUser","stateFolder","otherwise","$q","$stateParams","User","user","_","find","$users","uid","userId","angular","isUndefined","$filter","then","users","reject","$folders","$state","decodeUriFilter","AddressBook","Calendar","folder","o","folderId","$$folders","name","type","id","split","pop","owner","displayName","selectedFolder","runBlock","$log","$rootScope","$on","event","toState","toParams","fromState","fromParams","error","go","current","previous","rejection","config","run","$inject","AdministrationAclController","$animate","$mdToast","getTemplate","isDefined","$cards","selectUser","vm","selectedUid","selectedUser","$rights","userFilter","$query","$acl","dry","removeUser","$removeUser","data","status","Dialog","alert","l","addUser","$addUser","userToAdd","searchText","close","save","$saveUsersRights","show","simple","content","position","hideDelay","this","folderType","AdministrationController","$mdDialog","encodeUriFilter","Administration","filter","i","selectFolder"],"mappings":"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","sourcesContent":["/* -*- Mode: javascript; indent-tabs-mode: nil; c-basic-offset: 2 -*- */\n/* JavaScript for SOGoAdministration */\n\n(function() {\n  'use strict';\n\n  angular.module('SOGo.AdministrationUI', ['ngSanitize', 'ui.router', 'SOGo.Common', 'SOGo.Authentication', 'SOGo.PreferencesUI', 'SOGo.ContactsUI', 'SOGo.SchedulerUI'])\n    .config(configure)\n    .run(runBlock);\n\n  /**\n   * @ngInject\n   */\n  configure.$inject = ['$stateProvider', '$urlRouterProvider'];\n  function configure($stateProvider, $urlRouterProvider) {\n    $stateProvider\n      .state('administration', {\n        abstract: true,\n        views: {\n          administration: {\n            templateUrl: 'administration.html',\n            controller: 'AdministrationController',\n            controllerAs: 'app'\n          }\n        }\n      })\n      .state('administration.rights', {\n        url: '/rights',\n        views: {\n          module: {\n            templateUrl: 'rights.html'\n          }\n        }\n      })\n      .state('administration.rights.edit', {\n        url: '/:userId/:folderId/edit',\n        views: {\n          acl: {\n            templateUrl: 'UIxAdministrationAclEditor', // UI/Templates/Administration/UIxAdministrationAclEditor.wox\n            controller: 'AdministrationAclController',\n            controllerAs: 'acl'\n          }\n        },\n        resolve: {\n          stateUser: stateUser,\n          stateFolder: stateFolder\n        }\n      });\n\n    // if none of the above states are matched, use this as the fallback\n    $urlRouterProvider.otherwise('/rights');\n  }\n\n  /**\n   * @ngInject\n   */\n  stateUser.$inject = ['$q', '$stateParams', 'User'];\n  function stateUser($q, $stateParams, User) {\n    var user;\n\n    user = _.find(User.$users, function(user) {\n      return user.uid == $stateParams.userId;\n    });\n\n    if (angular.isUndefined(user)) {\n      return User.$filter($stateParams.userId).then(function(users) {\n        user = _.find(User.$users, function(user) {\n          return user.uid == $stateParams.userId;\n        });\n        if (angular.isUndefined(user)) {\n          return $q.reject('User with ID ' + $stateParams.userId + ' not found');\n        }\n        else {\n          // Resolve folders\n          return user.$folders().then(function() {\n            return user;\n          });\n        }\n        return user;\n      });\n    }\n\n    return user;\n  }\n\n  /**\n   * @ngInject\n   */\n  stateFolder.$inject = ['$state', '$stateParams', 'decodeUriFilter', 'stateUser', 'AddressBook', 'Calendar'];\n  function stateFolder($state, $stateParams, decodeUriFilter, stateUser, AddressBook, Calendar) {\n    var folder, o,\n        folderId = decodeUriFilter($stateParams.folderId);\n\n    folder = _.find(stateUser.$$folders, function(folder) {\n      return folder.name == folderId;\n    });\n    \n    if (folder.type == \"Appointment\") {\n      o = new Calendar({ id: folder.name.split('/').pop(),\n                         owner: folder.owner,\n                         name: folder.displayName });\n    } else {\n      o = new AddressBook({ id: folder.name.split('/').pop(),\n                            owner: folder.owner,\n                            name: folder.displayName });\n    }\n\n    stateUser.selectedFolder = o.id;\n\n    return o;\n  }\n\n  /**\n   * @ngInject\n   */\n  runBlock.$inject = ['$log', '$rootScope', '$state'];\n  function runBlock($log, $rootScope, $state) {\n    $rootScope.$on('$stateChangeError', function(event, toState, toParams, fromState, fromParams, error) {\n      $log.error(error);\n      $state.go('administration.rights');\n    });\n    $rootScope.$on('$routeChangeError', function(event, current, previous, rejection) {\n      $log.error(event, current, previous, rejection);\n    });\n  }\n\n})();\n","/* -*- Mode: javascript; indent-tabs-mode: nil; c-basic-offset: 2 -*- */\n/* JavaScript for SOGoAdministration */\n\n(function() {\n  'use strict';\n  \n  /**\n   * @ngInject\n   */\n  AdministrationAclController.$inject = ['$animate', '$state', '$mdToast', 'stateUser', 'stateFolder', 'User'];\n  function AdministrationAclController($animate, $state, $mdToast, stateUser, stateFolder, User) {\n    var vm = this;\n\n    vm.user = stateUser;\n    vm.folder = stateFolder;\n    vm.folderType = angular.isDefined(stateFolder.$cards)? 'AddressBook' : 'Calendar';\n    vm.selectedUser = null;\n    vm.selectedUid = null;\n    vm.selectUser = selectUser;\n    vm.removeUser = removeUser;\n    vm.getTemplate = getTemplate;\n    vm.close = close;\n    vm.save = save;\n\n    vm.userToAdd = '';\n    vm.searchText = '';\n    vm.userFilter = userFilter;\n    vm.addUser = addUser;\n\n    stateFolder.$acl.$users(stateFolder.owner).then(function(data) {\n      vm.users = data;\n    });\n\n    function getTemplate() {\n      if (angular.isDefined(stateFolder.$cards))\n        return '../' + stateFolder.owner + '/Contacts/' + stateFolder.id + '/UIxContactsUserRightsEditor';\n\n      return '../' + stateFolder.owner + '/Calendar/' + stateFolder.id + '/UIxCalUserRightsEditor';\n    }\n\n    function selectUser(user) {\n      if (vm.selectedUid == user.uid) {\n        vm.selectedUid = null;\n      }\n      else {\n        vm.selectedUid = user.uid;\n        vm.selectedUser = user;\n        vm.selectedUser.$rights();\n      }\n    }\n\n    function userFilter($query) {\n      return User.$filter($query, stateFolder.$acl.users, { dry: true });\n    }\n\n    function removeUser(user) {\n      stateFolder.$acl.$removeUser(user.uid).catch(function(data, status) {\n        Dialog.alert(l('Warning'), l('An error occured please try again.'));\n      });\n    }\n\n    function addUser(data) {\n      if (data) {\n        stateFolder.$acl.$addUser(data, stateFolder.owner).then(function() {\n          vm.userToAdd = '';\n          vm.searchText = '';\n        }, function(error) {\n          Dialog.alert(l('Warning'), error);\n        });\n      }\n    }\n\n    function close() {\n      $state.go('administration.rights').then(function() {\n        delete vm.user.selectedFolder;\n        vm.user = null;\n      });\n    }\n\n    function save() {\n      stateFolder.$acl.$saveUsersRights(stateFolder.owner).then(function() {\n        $mdToast.show(\n          $mdToast.simple()\n            .content(l('ACLs saved'))\n            .position('top right')\n            .hideDelay(3000)\n        );\n      }, function(data, status) {\n        Dialog.alert(l('Warning'), l('An error occured please try again.'));\n      });\n    }\n  }\n\n  angular\n    .module('SOGo.AdministrationUI')\n    .controller('AdministrationAclController', AdministrationAclController);\n\n})();\n","/* -*- Mode: javascript; indent-tabs-mode: nil; c-basic-offset: 2 -*- */\n/* JavaScript for SOGoAdministration */\n\n(function() {\n  'use strict';\n  \n  /**\n   * @ngInject\n   */\n  AdministrationController.$inject = ['$state', '$mdDialog', '$mdToast', 'Dialog', 'encodeUriFilter', 'User', 'Administration'];\n  function AdministrationController($state, $mdDialog, $mdToast, Dialog, encodeUriFilter, User, Administration) {\n    var vm = this;\n\n    vm.administration = Administration;\n\n    vm.selectedUser = null;\n    vm.users = User.$users;\n\n    vm.go = go;\n    vm.filter = filter;\n    vm.selectUser = selectUser;\n    vm.selectFolder = selectFolder;\n\n    function go(module) {\n      $state.go('administration.' + module);\n    }\n\n    function filter(searchText) {\n      User.$filter(searchText);\n    }\n\n    function selectUser(i) {\n      if (vm.selectedUser == vm.users[i]) {\n        vm.selectedUser = null;\n      }\n      else {\n        // Fetch folders of specific type for selected user\n        vm.users[i].$folders().then(function() {\n          vm.selectedUser = vm.users[i];\n        });\n      }\n    }\n\n    function selectFolder(folder) {\n      $state.go('administration.rights.edit', {userId: vm.selectedUser.uid, folderId: encodeUriFilter(folder.name)});\n    }\n\n  }\n\n  angular\n    .module('SOGo.AdministrationUI')\n    .controller('AdministrationController', AdministrationController);\n\n})();\n"]}